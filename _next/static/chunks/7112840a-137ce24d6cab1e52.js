"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(e,t,n){n.d(t,{u7:function(){return fu},Jj:function(){return uc},IX:function(){return Wa},my:function(){return Pa},xU:function(){return Kc},Lz:function(){return cc},WA:function(){return S},F8:function(){return lc},$q:function(){return $c},W:function(){return jc},EK:function(){return U},PU:function(){return pu},l7:function(){return ka},Ky:function(){return ce},Xb:function(){return W},Cf:function(){return Ra},K9:function(){return T},Me:function(){return Y},yq:function(){return y},Wi:function(){return Na},ET:function(){return Nu},Ab:function(){return Vu},vr:function(){return Pu},Fc:function(){return tc},hJ:function(){return Ua},B$:function(){return Ba},at:function(){return Oa},oe:function(){return Au},AK:function(){return Fu},TF:function(){return sc},JU:function(){return Ka},ST:function(){return Xa},fH:function(){return Za},Ix:function(){return rc},Wu:function(){return cu},Lx:function(){return au},qY:function(){return Ya},GL:function(){return xu},QT:function(){return wu},kl:function(){return Iu},Xk:function(){return Tu},PL:function(){return Eu},UQ:function(){return bu},zN:function(){return Su},nP:function(){return qu},b9:function(){return tu},vh:function(){return nu},Pb:function(){return ic},L$:function(){return oc},cf:function(){return Du},sc:function(){return Cu},Xo:function(){return Zc},IO:function(){return Hc},iE:function(){return ja},Eo:function(){return $a},i3:function(){return Mu},Bt:function(){return Ou},pl:function(){return ku},Ub:function(){return m},qK:function(){return zc},TQ:function(){return iu},e0:function(){return su},r7:function(){return _u},Mx:function(){return nc},ar:function(){return Jc}});var r=n(2238),s=n(8463),i=n(3333),o=n(4444),a=n(3510),c=n(3454);const u="@firebase/firestore";class h{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}h.UNAUTHENTICATED=new h(null),h.GOOGLE_CREDENTIALS=new h("google-credentials-uid"),h.FIRST_PARTY=new h("first-party-uid"),h.MOCK_USER=new h("mock-user");let l="9.6.5";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(e){d.setLogLevel(e)}function g(e,...t){if(d.logLevel<=i.in.DEBUG){const n=t.map(w);d.debug(`Firestore (${l}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.in.ERROR){const n=t.map(w);d.error(`Firestore (${l}): ${e}`,...n)}}function y(e,...t){if(d.logLevel<=i.in.WARN){const n=t.map(w);d.warn(`Firestore (${l}): ${e}`,...n)}}function w(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function v(e="Unexpected state"){const t=`FIRESTORE (${l}) INTERNAL ASSERTION FAILED: `+e;throw p(t),new Error(t)}function I(e,t){e||v()}function T(e,t){e||v()}function E(e,t){return e}const b={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends o.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class k{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class _{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class A{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(h.UNAUTHENTICATED)))}shutdown(){}}class N{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class D{constructor(e){this.t=e,this.currentUser=h.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new k;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new k,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new k)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(I("string"==typeof t.accessToken),new _(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return I(null===e||"string"==typeof e),new h(e)}}class C{constructor(e,t,n){this.type="FirstParty",this.user=h.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",t);const r=e.auth.getAuthHeaderValueForFirstParty([]);r&&this.headers.set("Authorization",r),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class x{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new C(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(h.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class R{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e){this.g=e,this.forceRefresh=!1,this.appCheck=null}start(e,t){this.o=n=>{e.enqueueRetryable((()=>(e=>(null!=e.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`),t(e.token)))(n)))};const n=e=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.g.onInit((e=>n(e))),setTimeout((()=>{if(!this.appCheck){const e=this.g.getImmediate({optional:!0});e?n(e):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(I("string"==typeof e.token),new R(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class M{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.p(e),this.T=e=>t.writeSequenceNumber(e))}p(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.T&&this.T(e),e}}function F(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}M.I=-1;class O{static A(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const r=F(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%e.length))}return n}}function P(e,t){return e<t?-1:e>t?1:0}function V(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function q(e){return e+"\0"}class U{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new S(b.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new S(b.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new S(b.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new S(b.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return U.fromMillis(Date.now())}static fromDate(e){return U.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new U(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?P(this.nanoseconds,e.nanoseconds):P(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class B{constructor(e){this.timestamp=e}static fromTimestamp(e){return new B(e)}static min(){return new B(new U(0,0))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function K(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function $(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function j(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class G{constructor(e,t,n){void 0===t?t=0:t>e.length&&v(),void 0===n?n=e.length-t:n>e.length-t&&v(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===G.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof G?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class z extends G{construct(e,t,n){return new z(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new S(b.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new z(t)}static emptyPath(){return new z([])}}const Q=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends G{construct(e,t,n){return new W(e,t,n)}static isValidIdentifier(e){return Q.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new W(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new S(b.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new S(b.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new S(b.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new S(b.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new W(t)}static emptyPath(){return new W([])}}class H{constructor(e){this.fields=e,e.sort(W.comparator)}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return V(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}function Y(){return"undefined"!=typeof atob}class J{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new J(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new J(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return P(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}J.EMPTY_BYTE_STRING=new J("");const X=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Z(e){if(I(!!e),"string"==typeof e){let t=0;const n=X.exec(e);if(I(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:ee(e.seconds),nanos:ee(e.nanos)}}function ee(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function te(e){return"string"==typeof e?J.fromBase64String(e):J.fromUint8Array(e)}function ne(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function re(e){const t=e.mapValue.fields.__previous_value__;return ne(t)?re(t):t}function se(e){const t=Z(e.mapValue.fields.__local_write_time__.timestampValue);return new U(t.seconds,t.nanos)}function ie(e){return null==e}function oe(e){return 0===e&&1/e==-1/0}function ae(e){return"number"==typeof e&&Number.isInteger(e)&&!oe(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}class ce{constructor(e){this.path=e}static fromPath(e){return new ce(z.fromString(e))}static fromName(e){return new ce(z.fromString(e).popFirst(5))}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}isEqual(e){return null!==e&&0===z.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return z.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new ce(new z(e.slice()))}}function ue(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?ne(e)?4:10:v()}function he(e,t){if(e===t)return!0;const n=ue(e);if(n!==ue(t))return!1;switch(n){case 0:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return se(e).isEqual(se(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=Z(e.timestampValue),r=Z(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return te(e.bytesValue).isEqual(te(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ee(e.geoPointValue.latitude)===ee(t.geoPointValue.latitude)&&ee(e.geoPointValue.longitude)===ee(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ee(e.integerValue)===ee(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ee(e.doubleValue),r=ee(t.doubleValue);return n===r?oe(n)===oe(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return V(e.arrayValue.values||[],t.arrayValue.values||[],he);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(K(n)!==K(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!he(n[s],r[s])))return!1;return!0}(e,t);default:return v()}}function le(e,t){return void 0!==(e.values||[]).find((e=>he(e,t)))}function de(e,t){if(e===t)return 0;const n=ue(e),r=ue(t);if(n!==r)return P(n,r);switch(n){case 0:return 0;case 1:return P(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=ee(e.integerValue||e.doubleValue),r=ee(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return fe(e.timestampValue,t.timestampValue);case 4:return fe(se(e),se(t));case 5:return P(e.stringValue,t.stringValue);case 6:return function(e,t){const n=te(e),r=te(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=P(n[s],r[s]);if(0!==e)return e}return P(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=P(ee(e.latitude),ee(t.latitude));return 0!==n?n:P(ee(e.longitude),ee(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=de(n[s],r[s]);if(e)return e}return P(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const e=P(r[o],i[o]);if(0!==e)return e;const t=de(n[r[o]],s[i[o]]);if(0!==t)return t}return P(r.length,i.length)}(e.mapValue,t.mapValue);default:throw v()}}function fe(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return P(e,t);const n=Z(e),r=Z(t),s=P(n.seconds,r.seconds);return 0!==s?s:P(n.nanos,r.nanos)}function me(e){return ge(e)}function ge(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Z(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?te(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,ce.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=ge(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${ge(e.fields[s])}`;return n+"}"}(e.mapValue):v();var t,n}function pe(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function ye(e){return!!e&&"integerValue"in e}function we(e){return!!e&&"arrayValue"in e}function ve(e){return!!e&&"nullValue"in e}function Ie(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Te(e){return!!e&&"mapValue"in e}function Ee(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return $(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Ee(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Ee(e.arrayValue.values[n]);return t}return Object.assign({},e)}class be{constructor(e){this.value=e}static empty(){return new be({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Te(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Ee(t)}setAll(e){let t=W.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=Ee(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());Te(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return he(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];Te(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){$(t,((t,n)=>e[t]=n));for(const r of n)delete e[r]}clone(){return new be(Ee(this.value))}}function Se(e){const t=[];return $(e.fields,((e,n)=>{const r=new W([e]);if(Te(n)){const e=Se(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new H(t)}class ke{constructor(e,t,n,r,s){this.key=e,this.documentType=t,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(e){return new ke(e,0,B.min(),be.empty(),0)}static newFoundDocument(e,t,n){return new ke(e,1,t,n,0)}static newNoDocument(e,t){return new ke(e,2,t,be.empty(),0)}static newUnknownDocument(e,t){return new ke(e,3,t,be.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=be.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=be.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ke&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ke(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class _e{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.R=null}}function Ae(e,t=null,n=[],r=[],s=null,i=null,o=null){return new _e(e,t,n,r,s,i,o)}function Ne(e){const t=E(e);if(null===t.R){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>function(e){return e.field.canonicalString()+e.op.toString()+me(e.value)}(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),ie(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=Be(t.startAt)),t.endAt&&(e+="|ub:",e+=Be(t.endAt)),t.R=e}return t.R}function De(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let s=0;s<e.orderBy.length;s++)if(!$e(e.orderBy[s],t.orderBy[s]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let s=0;s<e.filters.length;s++)if(n=e.filters[s],r=t.filters[s],n.op!==r.op||!n.field.isEqual(r.field)||!he(n.value,r.value))return!1;var n,r;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Ge(e.startAt,t.startAt)&&Ge(e.endAt,t.endAt)}function Ce(e){return ce.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class xe extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.P(e,t,n):new Re(e,t,n):"array-contains"===t?new Oe(e,n):"in"===t?new Pe(e,n):"not-in"===t?new Ve(e,n):"array-contains-any"===t?new qe(e,n):new xe(e,t,n)}static P(e,t,n){return"in"===t?new Le(e,n):new Me(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.v(de(t,this.value)):null!==t&&ue(this.value)===ue(t)&&this.v(de(t,this.value))}v(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return v()}}V(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Re extends xe{constructor(e,t,n){super(e,t,n),this.key=ce.fromName(n.referenceValue)}matches(e){const t=ce.comparator(e.key,this.key);return this.v(t)}}class Le extends xe{constructor(e,t){super(e,"in",t),this.keys=Fe("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class Me extends xe{constructor(e,t){super(e,"not-in",t),this.keys=Fe("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function Fe(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>ce.fromName(e.referenceValue)))}class Oe extends xe{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return we(t)&&le(t.arrayValue,this.value)}}class Pe extends xe{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&le(this.value.arrayValue,t)}}class Ve extends xe{constructor(e,t){super(e,"not-in",t)}matches(e){if(le(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!le(this.value.arrayValue,t)}}class qe extends xe{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!we(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>le(this.value.arrayValue,e)))}}class Ue{constructor(e,t){this.position=e,this.before=t}}function Be(e){return`${e.before?"b":"a"}:${e.position.map((e=>me(e))).join(",")}`}class Ke{constructor(e,t="asc"){this.field=e,this.dir=t}}function $e(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}function je(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?ce.comparator(ce.fromName(o.referenceValue),n.key):de(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return e.before?r<=0:r<0}function Ge(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.before!==t.before||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!he(e.position[n],t.position[n]))return!1;return!0}class ze{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.S=null,this.D=null,this.startAt,this.endAt}}function Qe(e,t,n,r,s,i,o,a){return new ze(e,t,n,r,s,i,o,a)}function We(e){return new ze(e)}function He(e){return!ie(e.limit)&&"F"===e.limitType}function Ye(e){return!ie(e.limit)&&"L"===e.limitType}function Je(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function Xe(e){for(const t of e.filters)if(t.V())return t.field;return null}function Ze(e){return null!==e.collectionGroup}function et(e){const t=E(e);if(null===t.S){t.S=[];const e=Xe(t),n=Je(t);if(null!==e&&null===n)e.isKeyField()||t.S.push(new Ke(e)),t.S.push(new Ke(W.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.S.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.S.push(new Ke(W.keyField(),e))}}}return t.S}function tt(e){const t=E(e);if(!t.D)if("F"===t.limitType)t.D=Ae(t.path,t.collectionGroup,et(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of et(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Ke(s.field,t))}const n=t.endAt?new Ue(t.endAt.position,!t.endAt.before):null,r=t.startAt?new Ue(t.startAt.position,!t.startAt.before):null;t.D=Ae(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.D}function nt(e,t,n){return new ze(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function rt(e,t){return De(tt(e),tt(t))&&e.limitType===t.limitType}function st(e){return`${Ne(tt(e))}|lt:${e.limitType}`}function it(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>{return`${(t=e).field.canonicalString()} ${t.op} ${me(t.value)}`;var t})).join(", ")}]`),ie(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: "+Be(e.startAt)),e.endAt&&(t+=", endAt: "+Be(e.endAt)),`Target(${t})`}(tt(e))}; limitType=${e.limitType})`}function ot(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):ce.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of e.explicitOrderBy)if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!je(e.startAt,et(e),t))&&(!e.endAt||!je(e.endAt,et(e),t))}(e,t)}function at(e){return(t,n)=>{let r=!1;for(const s of et(e)){const e=ct(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function ct(e,t,n){const r=e.field.isKeyField()?ce.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?de(r,s):v()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return v()}}function ut(e,t){if(e.C){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:oe(t)?"-0":t}}function ht(e){return{integerValue:""+e}}function lt(e,t){return ae(t)?ht(t):ut(e,t)}class dt{constructor(){this._=void 0}}function ft(e,t,n){return e instanceof pt?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof yt?wt(e,t):e instanceof vt?It(e,t):function(e,t){const n=gt(e,t),r=Et(n)+Et(e.N);return ye(n)&&ye(e.N)?ht(r):ut(e.k,r)}(e,t)}function mt(e,t,n){return e instanceof yt?wt(e,t):e instanceof vt?It(e,t):n}function gt(e,t){return e instanceof Tt?ye(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class pt extends dt{}class yt extends dt{constructor(e){super(),this.elements=e}}function wt(e,t){const n=bt(t);for(const r of e.elements)n.some((e=>he(e,r)))||n.push(r);return{arrayValue:{values:n}}}class vt extends dt{constructor(e){super(),this.elements=e}}function It(e,t){let n=bt(t);for(const r of e.elements)n=n.filter((e=>!he(e,r)));return{arrayValue:{values:n}}}class Tt extends dt{constructor(e,t){super(),this.k=e,this.N=t}}function Et(e){return ee(e.integerValue||e.doubleValue)}function bt(e){return we(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class St{constructor(e,t){this.field=e,this.transform=t}}class kt{constructor(e,t){this.version=e,this.transformResults=t}}class _t{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new _t}static exists(e){return new _t(void 0,e)}static updateTime(e){return new _t(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function At(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Nt{}function Dt(e,t,n){e instanceof Mt?function(e,t,n){const r=e.value.clone(),s=Pt(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Ft?function(e,t,n){if(!At(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Pt(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Ot(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Ct(e,t,n){e instanceof Mt?function(e,t,n){if(!At(e.precondition,t))return;const r=e.value.clone(),s=Vt(e.fieldTransforms,n,t);r.setAll(s),t.convertToFoundDocument(Lt(t),r).setHasLocalMutations()}(e,t,n):e instanceof Ft?function(e,t,n){if(!At(e.precondition,t))return;const r=Vt(e.fieldTransforms,n,t),s=t.data;s.setAll(Ot(e)),s.setAll(r),t.convertToFoundDocument(Lt(t),s).setHasLocalMutations()}(e,t,n):function(e,t){At(e.precondition,t)&&t.convertToNoDocument(B.min())}(e,t)}function xt(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=gt(r.transform,e||null);null!=s&&(null==n&&(n=be.empty()),n.set(r.field,s))}return n||null}function Rt(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&V(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof yt&&t instanceof yt||e instanceof vt&&t instanceof vt?V(e.elements,t.elements,he):e instanceof Tt&&t instanceof Tt?he(e.N,t.N):e instanceof pt&&t instanceof pt}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}function Lt(e){return e.isFoundDocument()?e.version:B.min()}class Mt extends Nt{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Ft extends Nt{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Ot(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function Pt(e,t,n){const r=new Map;I(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,mt(o,a,n[s]))}return r}function Vt(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,ft(e,i,t))}return r}class qt extends Nt{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}}class Ut extends Nt{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}}class Bt{constructor(e){this.count=e}}var Kt,$t;function jt(e){switch(e){default:return v();case b.CANCELLED:case b.UNKNOWN:case b.DEADLINE_EXCEEDED:case b.RESOURCE_EXHAUSTED:case b.INTERNAL:case b.UNAVAILABLE:case b.UNAUTHENTICATED:return!1;case b.INVALID_ARGUMENT:case b.NOT_FOUND:case b.ALREADY_EXISTS:case b.PERMISSION_DENIED:case b.FAILED_PRECONDITION:case b.ABORTED:case b.OUT_OF_RANGE:case b.UNIMPLEMENTED:case b.DATA_LOSS:return!0}}function Gt(e){if(void 0===e)return p("GRPC error has no .code"),b.UNKNOWN;switch(e){case Kt.OK:return b.OK;case Kt.CANCELLED:return b.CANCELLED;case Kt.UNKNOWN:return b.UNKNOWN;case Kt.DEADLINE_EXCEEDED:return b.DEADLINE_EXCEEDED;case Kt.RESOURCE_EXHAUSTED:return b.RESOURCE_EXHAUSTED;case Kt.INTERNAL:return b.INTERNAL;case Kt.UNAVAILABLE:return b.UNAVAILABLE;case Kt.UNAUTHENTICATED:return b.UNAUTHENTICATED;case Kt.INVALID_ARGUMENT:return b.INVALID_ARGUMENT;case Kt.NOT_FOUND:return b.NOT_FOUND;case Kt.ALREADY_EXISTS:return b.ALREADY_EXISTS;case Kt.PERMISSION_DENIED:return b.PERMISSION_DENIED;case Kt.FAILED_PRECONDITION:return b.FAILED_PRECONDITION;case Kt.ABORTED:return b.ABORTED;case Kt.OUT_OF_RANGE:return b.OUT_OF_RANGE;case Kt.UNIMPLEMENTED:return b.UNIMPLEMENTED;case Kt.DATA_LOSS:return b.DATA_LOSS;default:return v()}}($t=Kt||(Kt={}))[$t.OK=0]="OK",$t[$t.CANCELLED=1]="CANCELLED",$t[$t.UNKNOWN=2]="UNKNOWN",$t[$t.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",$t[$t.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",$t[$t.NOT_FOUND=5]="NOT_FOUND",$t[$t.ALREADY_EXISTS=6]="ALREADY_EXISTS",$t[$t.PERMISSION_DENIED=7]="PERMISSION_DENIED",$t[$t.UNAUTHENTICATED=16]="UNAUTHENTICATED",$t[$t.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",$t[$t.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",$t[$t.ABORTED=10]="ABORTED",$t[$t.OUT_OF_RANGE=11]="OUT_OF_RANGE",$t[$t.UNIMPLEMENTED=12]="UNIMPLEMENTED",$t[$t.INTERNAL=13]="INTERNAL",$t[$t.UNAVAILABLE=14]="UNAVAILABLE",$t[$t.DATA_LOSS=15]="DATA_LOSS";class zt{constructor(e,t){this.comparator=e,this.root=t||Wt.EMPTY}insert(e,t){return new zt(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Wt.BLACK,null,null))}remove(e){return new zt(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Wt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Qt(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Qt(this.root,e,this.comparator,!1)}getReverseIterator(){return new Qt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Qt(this.root,e,this.comparator,!0)}}class Qt{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Wt{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:Wt.RED,this.left=null!=r?r:Wt.EMPTY,this.right=null!=s?s:Wt.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new Wt(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Wt.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return Wt.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,Wt.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,Wt.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const e=this.left.check();if(e!==this.right.check())throw v();return e+(this.isRed()?0:1)}}Wt.EMPTY=null,Wt.RED=!0,Wt.BLACK=!1,Wt.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(e,t,n,r,s){return this}insert(e,t,n){return new Wt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ht{constructor(e){this.comparator=e,this.data=new zt(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Yt(this.data.getIterator())}getIteratorFrom(e){return new Yt(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Ht))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Ht(this.comparator);return t.data=e,t}}class Yt{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const Jt=new zt(ce.comparator);function Xt(){return Jt}const Zt=new zt(ce.comparator);function en(){return Zt}const tn=new zt(ce.comparator);function nn(){return tn}const rn=new Ht(ce.comparator);function sn(...e){let t=rn;for(const n of e)t=t.add(n);return t}const on=new Ht(P);function an(){return on}class cn{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,un.createSynthesizedTargetChangeForCurrentChange(e,t)),new cn(B.min(),n,an(),Xt(),sn())}}class un{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t){return new un(J.EMPTY_BYTE_STRING,t,sn(),sn(),sn())}}class hn{constructor(e,t,n,r){this.$=e,this.removedTargetIds=t,this.key=n,this.O=r}}class ln{constructor(e,t){this.targetId=e,this.M=t}}class dn{constructor(e,t,n=J.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class fn{constructor(){this.F=0,this.L=pn(),this.B=J.EMPTY_BYTE_STRING,this.U=!1,this.q=!0}get current(){return this.U}get resumeToken(){return this.B}get K(){return 0!==this.F}get j(){return this.q}W(e){e.approximateByteSize()>0&&(this.q=!0,this.B=e)}G(){let e=sn(),t=sn(),n=sn();return this.L.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:v()}})),new un(this.B,this.U,e,t,n)}H(){this.q=!1,this.L=pn()}J(e,t){this.q=!0,this.L=this.L.insert(e,t)}Y(e){this.q=!0,this.L=this.L.remove(e)}X(){this.F+=1}Z(){this.F-=1}tt(){this.q=!0,this.U=!0}}class mn{constructor(e){this.et=e,this.nt=new Map,this.st=Xt(),this.it=gn(),this.rt=new Ht(P)}ot(e){for(const t of e.$)e.O&&e.O.isFoundDocument()?this.ct(t,e.O):this.at(t,e.key,e.O);for(const t of e.removedTargetIds)this.at(t,e.key,e.O)}ut(e){this.forEachTarget(e,(t=>{const n=this.ht(t);switch(e.state){case 0:this.lt(t)&&n.W(e.resumeToken);break;case 1:n.Z(),n.K||n.H(),n.W(e.resumeToken);break;case 2:n.Z(),n.K||this.removeTarget(t);break;case 3:this.lt(t)&&(n.tt(),n.W(e.resumeToken));break;case 4:this.lt(t)&&(this.ft(t),n.W(e.resumeToken));break;default:v()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.nt.forEach(((e,n)=>{this.lt(n)&&t(n)}))}dt(e){const t=e.targetId,n=e.M.count,r=this.wt(t);if(r){const e=r.target;if(Ce(e))if(0===n){const n=new ce(e.path);this.at(t,n,ke.newNoDocument(n,B.min()))}else I(1===n);else this._t(t)!==n&&(this.ft(t),this.rt=this.rt.add(t))}}gt(e){const t=new Map;this.nt.forEach(((n,r)=>{const s=this.wt(r);if(s){if(n.current&&Ce(s.target)){const t=new ce(s.target.path);null!==this.st.get(t)||this.yt(r,t)||this.at(r,t,ke.newNoDocument(t,e))}n.j&&(t.set(r,n.G()),n.H())}}));let n=sn();this.it.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.wt(e);return!t||2===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))}));const r=new cn(e,t,this.rt,this.st,n);return this.st=Xt(),this.it=gn(),this.rt=new Ht(P),r}ct(e,t){if(!this.lt(e))return;const n=this.yt(e,t.key)?2:0;this.ht(e).J(t.key,n),this.st=this.st.insert(t.key,t),this.it=this.it.insert(t.key,this.Tt(t.key).add(e))}at(e,t,n){if(!this.lt(e))return;const r=this.ht(e);this.yt(e,t)?r.J(t,1):r.Y(t),this.it=this.it.insert(t,this.Tt(t).delete(e)),n&&(this.st=this.st.insert(t,n))}removeTarget(e){this.nt.delete(e)}_t(e){const t=this.ht(e).G();return this.et.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}X(e){this.ht(e).X()}ht(e){let t=this.nt.get(e);return t||(t=new fn,this.nt.set(e,t)),t}Tt(e){let t=this.it.get(e);return t||(t=new Ht(P),this.it=this.it.insert(e,t)),t}lt(e){const t=null!==this.wt(e);return t||g("WatchChangeAggregator","Detected inactive target",e),t}wt(e){const t=this.nt.get(e);return t&&t.K?null:this.et.Et(e)}ft(e){this.nt.set(e,new fn),this.et.getRemoteKeysForTarget(e).forEach((t=>{this.at(e,t,null)}))}yt(e,t){return this.et.getRemoteKeysForTarget(e).has(t)}}function gn(){return new zt(ce.comparator)}function pn(){return new zt(ce.comparator)}const yn={asc:"ASCENDING",desc:"DESCENDING"},wn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class vn{constructor(e,t){this.databaseId=e,this.C=t}}function In(e,t){return e.C?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Tn(e,t){return e.C?t.toBase64():t.toUint8Array()}function En(e,t){return In(e,t.toTimestamp())}function bn(e){return I(!!e),B.fromTimestamp(function(e){const t=Z(e);return new U(t.seconds,t.nanos)}(e))}function Sn(e,t){return function(e){return new z(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function kn(e){const t=z.fromString(e);return I(Hn(t)),t}function _n(e,t){return Sn(e.databaseId,t.path)}function An(e,t){const n=kn(t);if(n.get(1)!==e.databaseId.projectId)throw new S(b.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new S(b.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new ce(xn(n))}function Nn(e,t){return Sn(e.databaseId,t)}function Dn(e){const t=kn(e);return 4===t.length?z.emptyPath():xn(t)}function Cn(e){return new z(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function xn(e){return I(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function Rn(e,t,n){return{name:_n(e,t),fields:n.value.mapValue.fields}}function Ln(e,t,n){const r=An(e,t.name),s=bn(t.updateTime),i=new be({mapValue:{fields:t.fields}}),o=ke.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Mn(e,t){let n;if(t instanceof Mt)n={update:Rn(e,t.key,t.value)};else if(t instanceof qt)n={delete:_n(e,t.key)};else if(t instanceof Ft)n={update:Rn(e,t.key,t.data),updateMask:Wn(t.fieldMask)};else{if(!(t instanceof Ut))return v();n={verify:_n(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof pt)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof yt)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof vt)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Tt)return{fieldPath:t.field.canonicalString(),increment:n.N};throw v()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:En(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:v()}(e,t.precondition)),n}function Fn(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?_t.updateTime(bn(e.updateTime)):void 0!==e.exists?_t.exists(e.exists):_t.none()}(t.currentDocument):_t.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)I("REQUEST_TIME"===t.setToServerValue),n=new pt;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new yt(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new vt(e)}else"increment"in t?n=new Tt(e,t.increment):v();const r=W.fromServerFormat(t.fieldPath);return new St(r,n)}(e,t))):[];if(t.update){t.update.name;const s=An(e,t.update.name),i=new be({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new H(t.map((e=>W.fromServerFormat(e))))}(t.updateMask);return new Ft(s,i,e,n,r)}return new Mt(s,i,n,r)}if(t.delete){const r=An(e,t.delete);return new qt(r,n)}if(t.verify){const r=An(e,t.verify);return new Ut(r,n)}return v()}function On(e,t){return{documents:[Nn(e,t.path)]}}function Pn(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Nn(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Nn(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(e){if(0===e.length)return;const t=e.map((e=>function(e){if("=="===e.op){if(Ie(e.value))return{unaryFilter:{field:jn(e.field),op:"IS_NAN"}};if(ve(e.value))return{unaryFilter:{field:jn(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ie(e.value))return{unaryFilter:{field:jn(e.field),op:"IS_NOT_NAN"}};if(ve(e.value))return{unaryFilter:{field:jn(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:jn(e.field),op:$n(e.op),value:e.value}}}(e)));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}(t.filters);s&&(n.structuredQuery.where=s);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:jn(e.field),direction:Kn(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(e,t){return e.C||ie(t)?t:{value:t}}(e,t.limit);return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt=Un(t.startAt)),t.endAt&&(n.structuredQuery.endAt=Un(t.endAt)),n}function Vn(e){let t=Dn(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){I(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=qn(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new Ke(Gn(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,ie(t)?null:t}(n.limit));let c=null;n.startAt&&(c=Bn(n.startAt));let u=null;return n.endAt&&(u=Bn(n.endAt)),Qe(t,s,o,i,a,"F",c,u)}function qn(e){return e?void 0!==e.unaryFilter?[Qn(e)]:void 0!==e.fieldFilter?[zn(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map((e=>qn(e))).reduce(((e,t)=>e.concat(t))):v():[]}function Un(e){return{before:e.before,values:e.position}}function Bn(e){const t=!!e.before,n=e.values||[];return new Ue(n,t)}function Kn(e){return yn[e]}function $n(e){return wn[e]}function jn(e){return{fieldPath:e.canonicalString()}}function Gn(e){return W.fromServerFormat(e.fieldPath)}function zn(e){return xe.create(Gn(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(e.fieldFilter.op),e.fieldFilter.value)}function Qn(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Gn(e.unaryFilter.field);return xe.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Gn(e.unaryFilter.field);return xe.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Gn(e.unaryFilter.field);return xe.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Gn(e.unaryFilter.field);return xe.create(s,"!=",{nullValue:"NULL_VALUE"});default:return v()}}function Wn(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Hn(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function Yn(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=Xn(t)),t=Jn(e.get(n),t);return Xn(t)}function Jn(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const t=e.charAt(s);switch(t){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=t}}return n}function Xn(e){return e+"\x01\x01"}function Zn(e){const t=e.length;if(I(t>=2),2===t)return I("\x01"===e.charAt(0)&&"\x01"===e.charAt(1)),z.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("\x01",i);switch((t<0||t>n)&&v(),e.charAt(t+1)){case"\x01":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=e.substring(i,t),s+="\0";break;case"\x11":s+=e.substring(i,t+1);break;default:v()}i=t+2}return new z(r)}class er{constructor(e,t){this.seconds=e,this.nanoseconds=t}}class tr{constructor(e,t,n){this.ownerId=e,this.allowTabSynchronization=t,this.leaseTimestampMs=n}}tr.store="owner",tr.key="owner";class nr{constructor(e,t,n){this.userId=e,this.lastAcknowledgedBatchId=t,this.lastStreamToken=n}}nr.store="mutationQueues",nr.keyPath="userId";class rr{constructor(e,t,n,r,s){this.userId=e,this.batchId=t,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}rr.store="mutations",rr.keyPath="batchId",rr.userMutationsIndex="userMutationsIndex",rr.userMutationsKeyPath=["userId","batchId"];class sr{constructor(){}static prefixForUser(e){return[e]}static prefixForPath(e,t){return[e,Yn(t)]}static key(e,t,n){return[e,Yn(t),n]}}sr.store="documentMutations",sr.PLACEHOLDER=new sr;class ir{constructor(e,t){this.path=e,this.readTime=t}}class or{constructor(e,t){this.path=e,this.version=t}}class ar{constructor(e,t,n,r,s,i){this.unknownDocument=e,this.noDocument=t,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}ar.store="remoteDocuments",ar.readTimeIndex="readTimeIndex",ar.readTimeIndexPath="readTime",ar.collectionReadTimeIndex="collectionReadTimeIndex",ar.collectionReadTimeIndexPath=["parentPath","readTime"];class cr{constructor(e){this.byteSize=e}}cr.store="remoteDocumentGlobal",cr.key="remoteDocumentGlobalKey";class ur{constructor(e,t,n,r,s,i,o){this.targetId=e,this.canonicalId=t,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}ur.store="targets",ur.keyPath="targetId",ur.queryTargetsIndexName="queryTargetsIndex",ur.queryTargetsKeyPath=["canonicalId","targetId"];class hr{constructor(e,t,n){this.targetId=e,this.path=t,this.sequenceNumber=n}}hr.store="targetDocuments",hr.keyPath=["targetId","path"],hr.documentTargetsIndex="documentTargetsIndex",hr.documentTargetsKeyPath=["path","targetId"];class lr{constructor(e,t,n,r){this.highestTargetId=e,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}lr.key="targetGlobalKey",lr.store="targetGlobal";class dr{constructor(e,t){this.collectionId=e,this.parent=t}}dr.store="collectionParents",dr.keyPath=["collectionId","parent"];class fr{constructor(e,t,n,r){this.clientId=e,this.updateTimeMs=t,this.networkEnabled=n,this.inForeground=r}}fr.store="clientMetadata",fr.keyPath="clientId";class mr{constructor(e,t,n){this.bundleId=e,this.createTime=t,this.version=n}}mr.store="bundles",mr.keyPath="bundleId";class gr{constructor(e,t,n){this.name=e,this.readTime=t,this.bundledQuery=n}}gr.store="namedQueries",gr.keyPath="name";const pr=[nr.store,rr.store,sr.store,ar.store,ur.store,tr.store,lr.store,hr.store,fr.store,cr.store,dr.store,mr.store,gr.store],yr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class wr{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}class vr{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new vr(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof vr?t:vr.resolve(t)}catch(e){return vr.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):vr.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):vr.reject(t)}static resolve(e){return new vr(((t,n)=>{t(e)}))}static reject(e){return new vr(((t,n)=>{n(e)}))}static waitFor(e){return new vr(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=vr.resolve(!1);for(const n of e)t=t.next((e=>e?vr.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}}class Ir{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.It=new k,this.transaction.oncomplete=()=>{this.It.resolve()},this.transaction.onabort=()=>{t.error?this.It.reject(new br(e,t.error)):this.It.resolve()},this.transaction.onerror=t=>{const n=Nr(t.target.error);this.It.reject(new br(e,n))}}static open(e,t,n,r){try{return new Ir(t,e.transaction(r,n))}catch(e){throw new br(t,e)}}get At(){return this.It.promise}abort(e){e&&this.It.reject(e),this.aborted||(g("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(e){const t=this.transaction.objectStore(e);return new kr(t)}}class Tr{constructor(e,t,n){this.name=e,this.version=t,this.Rt=n,12.2===Tr.bt((0,o.z$)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return g("SimpleDb","Removing database:",e),_r(window.indexedDB.deleteDatabase(e)).toPromise()}static Pt(){if(!(0,o.hl)())return!1;if(Tr.vt())return!0;const e=(0,o.z$)(),t=Tr.bt(e),n=0<t&&t<10,r=Tr.Vt(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static vt(){var e;return"undefined"!=typeof c&&"YES"===(null===(e=c.env)||void 0===e?void 0:e.St)}static Dt(e,t){return e.store(t)}static bt(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Vt(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Ct(e){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new br(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new S(b.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new S(b.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new br(e,r))},r.onupgradeneeded=e=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.Rt.Nt(t,r.transaction,e.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.kt&&(this.db.onversionchange=e=>this.kt(e)),this.db}xt(e){this.kt=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.Ct(e);const t=Ir.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).catch((e=>(t.abort(e),vr.reject(e)))).toPromise();return i.catch((()=>{})),await t.At,i}catch(e){const t="FirebaseError"!==e.name&&i<3;if(g("SimpleDb","Transaction failed with error:",e.message,"Retrying:",t),this.close(),!t)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Er{constructor(e){this.$t=e,this.Ot=!1,this.Mt=null}get isDone(){return this.Ot}get Ft(){return this.Mt}set cursor(e){this.$t=e}done(){this.Ot=!0}Lt(e){this.Mt=e}delete(){return _r(this.$t.delete())}}class br extends S{constructor(e,t){super(b.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Sr(e){return"IndexedDbTransactionError"===e.name}class kr{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(g("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),_r(n)}add(e){return g("SimpleDb","ADD",this.store.name,e,e),_r(this.store.add(e))}get(e){return _r(this.store.get(e)).next((t=>(void 0===t&&(t=null),g("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return g("SimpleDb","DELETE",this.store.name,e),_r(this.store.delete(e))}count(){return g("SimpleDb","COUNT",this.store.name),_r(this.store.count())}Bt(e,t){const n=this.cursor(this.options(e,t)),r=[];return this.Ut(n,((e,t)=>{r.push(t)})).next((()=>r))}qt(e,t){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Kt=!1;const r=this.cursor(n);return this.Ut(r,((e,t,n)=>n.delete()))}jt(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.Ut(r,t)}Qt(e){const t=this.cursor({});return new vr(((n,r)=>{t.onerror=e=>{const t=Nr(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}Ut(e,t){const n=[];return new vr(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new Er(s),o=t(s.primaryKey,s.value,i);if(o instanceof vr){const e=o.catch((e=>(i.done(),vr.reject(e))));n.push(e)}i.isDone?r():null===i.Ft?s.continue():s.continue(i.Ft)}})).next((()=>vr.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Kt?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function _r(e){return new vr(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=Nr(e.target.error);n(t)}}))}let Ar=!1;function Nr(e){const t=Tr.bt((0,o.z$)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ar||(Ar=!0,setTimeout((()=>{throw e}),0)),e}}return e}class Dr extends wr{constructor(e,t){super(),this.Wt=e,this.currentSequenceNumber=t}}function Cr(e,t){const n=E(e);return Tr.Dt(n.Wt,t)}class xr{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const t=this.mutations[r];t.key.isEqual(e.key)&&Dt(t,e,n[r])}}applyToLocalView(e){for(const t of this.baseMutations)t.key.isEqual(e.key)&&Ct(t,e,this.localWriteTime);for(const t of this.mutations)t.key.isEqual(e.key)&&Ct(t,e,this.localWriteTime)}applyToLocalDocumentSet(e){this.mutations.forEach((t=>{const n=e.get(t.key),r=n;this.applyToLocalView(r),n.isValidDocument()||r.convertToNoDocument(B.min())}))}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),sn())}isEqual(e){return this.batchId===e.batchId&&V(this.mutations,e.mutations,((e,t)=>Rt(e,t)))&&V(this.baseMutations,e.baseMutations,((e,t)=>Rt(e,t)))}}class Rr{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){I(e.mutations.length===n.length);let r=nn();const s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new Rr(e,t,n,r)}}class Lr{constructor(e,t,n,r,s=B.min(),i=B.min(),o=J.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new Lr(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new Lr(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new Lr(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Mr{constructor(e){this.Gt=e}}function Fr(e,t){if(t.document)return Ln(e.Gt,t.document,!!t.hasCommittedMutations);if(t.noDocument){const e=ce.fromSegments(t.noDocument.path),n=Ur(t.noDocument.readTime),r=ke.newNoDocument(e,n);return t.hasCommittedMutations?r.setHasCommittedMutations():r}if(t.unknownDocument){const e=ce.fromSegments(t.unknownDocument.path),n=Ur(t.unknownDocument.version);return ke.newUnknownDocument(e,n)}return v()}function Or(e,t,n){const r=Pr(n),s=t.key.path.popLast().toArray();if(t.isFoundDocument()){const n=function(e,t){return{name:_n(e,t.key),fields:t.data.value.mapValue.fields,updateTime:In(e,t.version.toTimestamp())}}(e.Gt,t),i=t.hasCommittedMutations;return new ar(null,null,n,i,r,s)}if(t.isNoDocument()){const e=t.key.path.toArray(),n=qr(t.version),i=t.hasCommittedMutations;return new ar(null,new ir(e,n),null,i,r,s)}if(t.isUnknownDocument()){const e=t.key.path.toArray(),n=qr(t.version);return new ar(new or(e,n),null,null,!0,r,s)}return v()}function Pr(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Vr(e){const t=new U(e[0],e[1]);return B.fromTimestamp(t)}function qr(e){const t=e.toTimestamp();return new er(t.seconds,t.nanoseconds)}function Ur(e){const t=new U(e.seconds,e.nanoseconds);return B.fromTimestamp(t)}function Br(e,t){const n=(t.baseMutations||[]).map((t=>Fn(e.Gt,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map((t=>Fn(e.Gt,t))),s=U.fromMillis(t.localWriteTimeMs);return new xr(t.batchId,s,n,r)}function Kr(e){const t=Ur(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Ur(e.lastLimboFreeSnapshotVersion):B.min();let r;var s;return void 0!==e.query.documents?(I(1===(s=e.query).documents.length),r=tt(We(Dn(s.documents[0])))):r=function(e){return tt(Vn(e))}(e.query),new Lr(r,e.targetId,0,e.lastListenSequenceNumber,t,n,J.fromBase64String(e.resumeToken))}function $r(e,t){const n=qr(t.snapshotVersion),r=qr(t.lastLimboFreeSnapshotVersion);let s;s=Ce(t.target)?On(e.Gt,t.target):Pn(e.Gt,t.target);const i=t.resumeToken.toBase64();return new ur(t.targetId,Ne(t.target),n,i,t.sequenceNumber,r,s)}function jr(e){const t=Vn({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?nt(t,t.limit,"L"):t}class Gr{getBundleMetadata(e,t){return zr(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:Ur(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return zr(e).put({bundleId:(n=t).id,createTime:qr(bn(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Qr(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:jr(t.bundledQuery),readTime:Ur(t.readTime)};var t}))}saveNamedQuery(e,t){return Qr(e).put(function(e){return{name:e.name,readTime:qr(bn(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function zr(e){return Cr(e,mr.store)}function Qr(e){return Cr(e,gr.store)}class Wr{constructor(){this.zt=new Hr}addToCollectionParentIndex(e,t){return this.zt.add(t),vr.resolve()}getCollectionParents(e,t){return vr.resolve(this.zt.getEntries(t))}}class Hr{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Ht(z.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Ht(z.comparator)).toArray()}}class Yr{constructor(){this.Ht=new Hr}addToCollectionParentIndex(e,t){if(!this.Ht.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.Ht.add(t)}));const s={collectionId:n,parent:Yn(r)};return Jr(e).put(s)}return vr.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[q(t),""],!1,!0);return Jr(e).Bt(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Zn(r.parent))}return n}))}}function Jr(e){return Cr(e,dr.store)}const Xr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Zr{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Zr(e,Zr.DEFAULT_COLLECTION_PERCENTILE,Zr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function es(e,t,n){const r=e.store(rr.store),s=e.store(sr.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.jt({range:o},((e,t,n)=>(a++,n.delete())));i.push(c.next((()=>{I(1===a)})));const u=[];for(const h of n.mutations){const e=sr.key(t,h.key.path,n.batchId);i.push(s.delete(e)),u.push(h.key)}return vr.waitFor(i).next((()=>u))}function ts(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw v();t=e.noDocument}return JSON.stringify(t).length}Zr.DEFAULT_COLLECTION_PERCENTILE=10,Zr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Zr.DEFAULT=new Zr(41943040,Zr.DEFAULT_COLLECTION_PERCENTILE,Zr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Zr.DISABLED=new Zr(-1,0,0);class ns{constructor(e,t,n,r){this.userId=e,this.k=t,this.Jt=n,this.referenceDelegate=r,this.Yt={}}static Xt(e,t,n,r){I(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new ns(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ss(e).jt({index:rr.userMutationsIndex,range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=is(e),i=ss(e);return i.add({}).next((o=>{I("number"==typeof o);const a=new xr(o,t,n,r),c=function(e,t,n){const r=n.baseMutations.map((t=>Mn(e.Gt,t))),s=n.mutations.map((t=>Mn(e.Gt,t)));return new rr(t,n.batchId,n.localWriteTime.toMillis(),r,s)}(this.k,this.userId,a),u=[];let h=new Ht(((e,t)=>P(e.canonicalString(),t.canonicalString())));for(const e of r){const t=sr.key(this.userId,e.key.path,o);h=h.add(e.key.path.popLast()),u.push(i.put(c)),u.push(s.put(t,sr.PLACEHOLDER))}return h.forEach((t=>{u.push(this.Jt.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Yt[o]=a.keys()})),vr.waitFor(u).next((()=>a))}))}lookupMutationBatch(e,t){return ss(e).get(t).next((e=>e?(I(e.userId===this.userId),Br(this.k,e)):null))}Zt(e,t){return this.Yt[t]?vr.resolve(this.Yt[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Yt[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return ss(e).jt({index:rr.userMutationsIndex,range:r},((e,t,r)=>{t.userId===this.userId&&(I(t.batchId>=n),s=Br(this.k,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return ss(e).jt({index:rr.userMutationsIndex,range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ss(e).Bt(rr.userMutationsIndex,t).next((e=>e.map((e=>Br(this.k,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=sr.prefixForPath(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return is(e).jt({range:r},((n,r,i)=>{const[o,a,c]=n,u=Zn(a);if(o===this.userId&&t.path.isEqual(u))return ss(e).get(c).next((e=>{if(!e)throw v();I(e.userId===this.userId),s.push(Br(this.k,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ht(P);const r=[];return t.forEach((t=>{const s=sr.prefixForPath(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=is(e).jt({range:i},((e,r,s)=>{const[i,o,a]=e,c=Zn(o);i===this.userId&&t.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),vr.waitFor(r).next((()=>this.te(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=sr.prefixForPath(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Ht(P);return is(e).jt({range:i},((e,t,s)=>{const[i,a,c]=e,u=Zn(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.te(e,o)))}te(e,t){const n=[],r=[];return t.forEach((t=>{r.push(ss(e).get(t).next((e=>{if(null===e)throw v();I(e.userId===this.userId),n.push(Br(this.k,e))})))})),vr.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return es(e.Wt,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.ee(t.batchId)})),vr.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}ee(e){delete this.Yt[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return vr.resolve();const n=IDBKeyRange.lowerBound(sr.prefixForUser(this.userId)),r=[];return is(e).jt({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Zn(e[1]);r.push(t)}else n.done()})).next((()=>{I(0===r.length)}))}))}containsKey(e,t){return rs(e,this.userId,t)}ne(e){return os(e).get(this.userId).next((e=>e||new nr(this.userId,-1,"")))}}function rs(e,t,n){const r=sr.prefixForPath(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return is(e).jt({range:i,Kt:!0},((e,n,r)=>{const[i,a,c]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function ss(e){return Cr(e,rr.store)}function is(e){return Cr(e,sr.store)}function os(e){return Cr(e,nr.store)}class as{constructor(e){this.se=e}next(){return this.se+=2,this.se}static ie(){return new as(0)}static re(){return new as(-1)}}class cs{constructor(e,t){this.referenceDelegate=e,this.k=t}allocateTargetId(e){return this.oe(e).next((t=>{const n=new as(t.highestTargetId);return t.highestTargetId=n.next(),this.ce(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.oe(e).next((e=>B.fromTimestamp(new U(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.oe(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.oe(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.ce(e,r))))}addTargetData(e,t){return this.ae(e,t).next((()=>this.oe(e).next((n=>(n.targetCount+=1,this.ue(t,n),this.ce(e,n))))))}updateTargetData(e,t){return this.ae(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>us(e).delete(t.targetId))).next((()=>this.oe(e))).next((t=>(I(t.targetCount>0),t.targetCount-=1,this.ce(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return us(e).jt(((i,o)=>{const a=Kr(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>vr.waitFor(s))).next((()=>r))}forEachTarget(e,t){return us(e).jt(((e,n)=>{const r=Kr(n);t(r)}))}oe(e){return hs(e).get(lr.key).next((e=>(I(null!==e),e)))}ce(e,t){return hs(e).put(lr.key,t)}ae(e,t){return us(e).put($r(this.k,t))}ue(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.oe(e).next((e=>e.targetCount))}getTargetData(e,t){const n=Ne(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return us(e).jt({range:r,index:ur.queryTargetsIndexName},((e,n,r)=>{const i=Kr(n);De(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=ls(e);return t.forEach((t=>{const i=Yn(t.path);r.push(s.put(new hr(n,i))),r.push(this.referenceDelegate.addReference(e,n,t))})),vr.waitFor(r)}removeMatchingKeys(e,t,n){const r=ls(e);return vr.forEach(t,(t=>{const s=Yn(t.path);return vr.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=ls(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=ls(e);let s=sn();return r.jt({range:n,Kt:!0},((e,t,n)=>{const r=Zn(e[1]),i=new ce(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=Yn(t.path),r=IDBKeyRange.bound([n],[q(n)],!1,!0);let s=0;return ls(e).jt({index:hr.documentTargetsIndex,Kt:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}Et(e,t){return us(e).get(t).next((e=>e?Kr(e):null))}}function us(e){return Cr(e,ur.store)}function hs(e){return Cr(e,lr.store)}function ls(e){return Cr(e,hr.store)}async function ds(e){if(e.code!==b.FAILED_PRECONDITION||e.message!==yr)throw e;g("LocalStore","Unexpectedly lost primary lease")}function fs([e,t],[n,r]){const s=P(e,n);return 0===s?P(t,r):s}class ms{constructor(e){this.he=e,this.buffer=new Ht(fs),this.le=0}fe(){return++this.le}de(e){const t=[e,this.fe()];if(this.buffer.size<this.he)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();fs(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class gs{constructor(e,t){this.garbageCollector=e,this.asyncQueue=t,this.we=!1,this._e=null}start(e){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.me(e)}stop(){this._e&&(this._e.cancel(),this._e=null)}get started(){return null!==this._e}me(e){const t=this.we?3e5:6e4;g("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this._e=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this._e=null,this.we=!0;try{await e.collectGarbage(this.garbageCollector)}catch(e){Sr(e)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ds(e)}await this.me(e)}))}}class ps{constructor(e,t){this.ge=e,this.params=t}calculateTargetCount(e,t){return this.ge.ye(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return vr.resolve(M.I);const n=new ms(t);return this.ge.forEachTarget(e,(e=>n.de(e.sequenceNumber))).next((()=>this.ge.pe(e,(e=>n.de(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.ge.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.ge.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),vr.resolve(Xr)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Xr):this.Te(e,t)))}getCacheSize(e){return this.ge.getCacheSize(e)}Te(e,t){let n,r,s,o,a,c,u;const h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,c=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(u=Date.now(),f()<=i.in.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-h}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(c-a)+"ms\n"+`\tRemoved ${e} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-h}ms`),vr.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}class ys{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new ps(e,t)}(this,t)}ye(e){const t=this.Ee(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Ee(e){let t=0;return this.pe(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}pe(e,t){return this.Ie(e,((e,n)=>t(n)))}addReference(e,t,n){return ws(e,n)}removeReference(e,t,n){return ws(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return ws(e,t)}Ae(e,t){return function(e,t){let n=!1;return os(e).Qt((r=>rs(e,r,t).next((e=>(e&&(n=!0),vr.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Ie(e,((i,o)=>{if(o<=t){const t=this.Ae(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i),ls(e).delete([0,Yn(i.path)]))))}));r.push(t)}})).next((()=>vr.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return ws(e,t)}Ie(e,t){const n=ls(e);let r,s=M.I;return n.jt({index:hr.documentTargetsIndex},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==M.I&&t(new ce(Zn(r)),s),s=o,r=i):s=M.I})).next((()=>{s!==M.I&&t(new ce(Zn(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function ws(e,t){return ls(e).put(function(e,t){return new hr(0,Yn(e.path),t)}(t,e.currentSequenceNumber))}class vs{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={}}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0!==r){for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t])}else this.inner[n]=[[e,t]]}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),!0;return!1}forEach(e){$(this.inner,((t,n)=>{for(const[r,s]of n)e(r,s)}))}isEmpty(){return j(this.inner)}}class Is{constructor(){this.changes=new vs((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}getReadTime(e){const t=this.changes.get(e);return t?t.readTime:B.min()}addEntry(e,t){this.assertNotApplied(),this.changes.set(e.key,{document:e,readTime:t})}removeEntry(e,t=null){this.assertNotApplied(),this.changes.set(e,{document:ke.newInvalidDocument(e),readTime:t})}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?vr.resolve(n.document):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Ts{constructor(e,t){this.k=e,this.Jt=t}addEntry(e,t,n){return Ss(e).put(ks(t),n)}removeEntry(e,t){const n=Ss(e),r=ks(t);return n.delete(r)}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.Re(e,n))))}getEntry(e,t){return Ss(e).get(ks(t)).next((e=>this.be(t,e)))}Pe(e,t){return Ss(e).get(ks(t)).next((e=>({document:this.be(t,e),size:ts(e)})))}getEntries(e,t){let n=Xt();return this.ve(e,t,((e,t)=>{const r=this.be(e,t);n=n.insert(e,r)})).next((()=>n))}Ve(e,t){let n=Xt(),r=new zt(ce.comparator);return this.ve(e,t,((e,t)=>{const s=this.be(e,t);n=n.insert(e,s),r=r.insert(e,ts(t))})).next((()=>({documents:n,Se:r})))}ve(e,t,n){if(t.isEmpty())return vr.resolve();const r=IDBKeyRange.bound(t.first().path.toArray(),t.last().path.toArray()),s=t.getIterator();let i=s.getNext();return Ss(e).jt({range:r},((e,t,r)=>{const o=ce.fromSegments(e);for(;i&&ce.comparator(i,o)<0;)n(i,null),i=s.getNext();i&&i.isEqual(o)&&(n(i,t),i=s.hasNext()?s.getNext():null),i?r.Lt(i.path.toArray()):r.done()})).next((()=>{for(;i;)n(i,null),i=s.hasNext()?s.getNext():null}))}getDocumentsMatchingQuery(e,t,n){let r=Xt();const s=t.path.length+1,i={};if(n.isEqual(B.min())){const e=t.path.toArray();i.range=IDBKeyRange.lowerBound(e)}else{const e=t.path.toArray(),r=Pr(n);i.range=IDBKeyRange.lowerBound([e,r],!0),i.index=ar.collectionReadTimeIndex}return Ss(e).jt(i,((e,n,i)=>{if(e.length!==s)return;const o=Fr(this.k,n);t.path.isPrefixOf(o.key.path)?ot(t,o)&&(r=r.insert(o.key,o)):i.done()})).next((()=>r))}newChangeBuffer(e){return new Es(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return bs(e).get(cr.key).next((e=>(I(!!e),e)))}Re(e,t){return bs(e).put(cr.key,t)}be(e,t){if(t){const e=Fr(this.k,t);if(!e.isNoDocument()||!e.version.isEqual(B.min()))return e}return ke.newInvalidDocument(e)}}class Es extends Is{constructor(e,t){super(),this.De=e,this.trackRemovals=t,this.Ce=new vs((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new Ht(((e,t)=>P(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Ce.get(s);if(i.document.isValidDocument()){const a=Or(this.De.k,i.document,this.getReadTime(s));r=r.add(s.path.popLast());const c=ts(a);n+=c-o,t.push(this.De.addEntry(e,s,a))}else if(n-=o,this.trackRemovals){const n=Or(this.De.k,ke.newNoDocument(s,B.min()),this.getReadTime(s));t.push(this.De.addEntry(e,s,n))}else t.push(this.De.removeEntry(e,s))})),r.forEach((n=>{t.push(this.De.Jt.addToCollectionParentIndex(e,n))})),t.push(this.De.updateMetadata(e,n)),vr.waitFor(t)}getFromCache(e,t){return this.De.Pe(e,t).next((e=>(this.Ce.set(t,e.size),e.document)))}getAllFromCache(e,t){return this.De.Ve(e,t).next((({documents:e,Se:t})=>(t.forEach(((e,t)=>{this.Ce.set(e,t)})),e)))}}function bs(e){return Cr(e,cr.store)}function Ss(e){return Cr(e,ar.store)}function ks(e){return e.path.toArray()}class _s{constructor(e){this.k=e}Nt(e,t,n,r){I(n<r&&n>=0&&r<=11);const s=new Ir("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore(tr.store)}(e),function(e){e.createObjectStore(nr.store,{keyPath:nr.keyPath}),e.createObjectStore(rr.store,{keyPath:rr.keyPath,autoIncrement:!0}).createIndex(rr.userMutationsIndex,rr.userMutationsKeyPath,{unique:!0}),e.createObjectStore(sr.store)}(e),As(e),function(e){e.createObjectStore(ar.store)}(e));let i=vr.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore(hr.store),e.deleteObjectStore(ur.store),e.deleteObjectStore(lr.store)}(e),As(e)),i=i.next((()=>function(e){const t=e.store(lr.store),n=new lr(0,0,B.min().toTimestamp(),0);return t.put(lr.key,n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store(rr.store).Bt().next((n=>{e.deleteObjectStore(rr.store),e.createObjectStore(rr.store,{keyPath:rr.keyPath,autoIncrement:!0}).createIndex(rr.userMutationsIndex,rr.userMutationsKeyPath,{unique:!0});const r=t.store(rr.store),s=n.map((e=>r.put(e)));return vr.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore(fr.store,{keyPath:fr.keyPath})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.Ne(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore(cr.store)}(e),this.ke(s))))),n<7&&r>=7&&(i=i.next((()=>this.xe(s)))),n<8&&r>=8&&(i=i.next((()=>this.$e(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e),function(e){const t=e.objectStore(ar.store);t.createIndex(ar.readTimeIndex,ar.readTimeIndexPath,{unique:!1}),t.createIndex(ar.collectionReadTimeIndex,ar.collectionReadTimeIndexPath,{unique:!1})}(t)}))),n<10&&r>=10&&(i=i.next((()=>this.Oe(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore(mr.store,{keyPath:mr.keyPath})}(e),function(e){e.createObjectStore(gr.store,{keyPath:gr.keyPath})}(e)}))),i}ke(e){let t=0;return e.store(ar.store).jt(((e,n)=>{t+=ts(n)})).next((()=>{const n=new cr(t);return e.store(cr.store).put(cr.key,n)}))}Ne(e){const t=e.store(nr.store),n=e.store(rr.store);return t.Bt().next((t=>vr.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.Bt(rr.userMutationsIndex,r).next((n=>vr.forEach(n,(n=>{I(n.userId===t.userId);const r=Br(this.k,n);return es(e,t.userId,r).next((()=>{}))}))))}))))}xe(e){const t=e.store(hr.store),n=e.store(ar.store);return e.store(lr.store).get(lr.key).next((e=>{const r=[];return n.jt(((n,s)=>{const i=new z(n),o=function(e){return[0,Yn(e)]}(i);r.push(t.get(o).next((n=>n?vr.resolve():(n=>t.put(new hr(0,Yn(n),e.highestListenSequenceNumber)))(i))))})).next((()=>vr.waitFor(r)))}))}$e(e,t){e.createObjectStore(dr.store,{keyPath:dr.keyPath});const n=t.store(dr.store),r=new Hr,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Yn(r)})}};return t.store(ar.store).jt({Kt:!0},((e,t)=>{const n=new z(e);return s(n.popLast())})).next((()=>t.store(sr.store).jt({Kt:!0},(([e,t,n],r)=>{const i=Zn(t);return s(i.popLast())}))))}Oe(e){const t=e.store(ur.store);return t.jt(((e,n)=>{const r=Kr(n),s=$r(this.k,r);return t.put(s)}))}}function As(e){e.createObjectStore(hr.store,{keyPath:hr.keyPath}).createIndex(hr.documentTargetsIndex,hr.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(ur.store,{keyPath:ur.keyPath}).createIndex(ur.queryTargetsIndexName,ur.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(lr.store)}const Ns="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Ds{constructor(e,t,n,r,s,i,o,a,c,u){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Me=s,this.window=i,this.document=o,this.Fe=c,this.Le=u,this.Be=null,this.Ue=!1,this.isPrimary=!1,this.networkEnabled=!0,this.qe=null,this.inForeground=!1,this.Ke=null,this.je=null,this.Qe=Number.NEGATIVE_INFINITY,this.We=e=>Promise.resolve(),!Ds.Pt())throw new S(b.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ys(this,r),this.Ge=t+"main",this.k=new Mr(a),this.ze=new Tr(this.Ge,11,new _s(this.k)),this.He=new cs(this.referenceDelegate,this.k),this.Jt=new Yr,this.Je=function(e,t){return new Ts(e,t)}(this.k,this.Jt),this.Ye=new Gr,this.window&&this.window.localStorage?this.Xe=this.window.localStorage:(this.Xe=null,!1===u&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ze().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(b.FAILED_PRECONDITION,Ns);return this.tn(),this.en(),this.nn(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.He.getHighestSequenceNumber(e)))})).then((e=>{this.Be=new M(e,this.Fe)})).then((()=>{this.Ue=!0})).catch((e=>(this.ze&&this.ze.close(),Promise.reject(e))))}sn(e){return this.We=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.ze.xt((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Me.enqueueAndForget((async()=>{this.started&&await this.Ze()})))}Ze(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>xs(e).put(new fr(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next((()=>{if(this.isPrimary)return this.rn(e).next((e=>{e||(this.isPrimary=!1,this.Me.enqueueRetryable((()=>this.We(!1))))}))})).next((()=>this.on(e))).next((t=>this.isPrimary&&!t?this.cn(e).next((()=>!1)):!!t&&this.an(e).next((()=>!0)))))).catch((e=>{if(Sr(e))return g("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.Me.enqueueRetryable((()=>this.We(e))),this.isPrimary=e}))}rn(e){return Cs(e).get(tr.key).next((e=>vr.resolve(this.un(e))))}hn(e){return xs(e).delete(this.clientId)}async ln(){if(this.isPrimary&&!this.fn(this.Qe,18e5)){this.Qe=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=Cr(e,fr.store);return t.Bt().next((e=>{const n=this.dn(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return vr.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.Xe)for(const t of e)this.Xe.removeItem(this.wn(t.clientId))}}nn(){this.je=this.Me.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ze().then((()=>this.ln())).then((()=>this.nn()))))}un(e){return!!e&&e.ownerId===this.clientId}on(e){return this.Le?vr.resolve(!0):Cs(e).get(tr.key).next((t=>{if(null!==t&&this.fn(t.leaseTimestampMs,5e3)&&!this._n(t.ownerId)){if(this.un(t)&&this.networkEnabled)return!0;if(!this.un(t)){if(!t.allowTabSynchronization)throw new S(b.FAILED_PRECONDITION,Ns);return!1}}return!(!this.networkEnabled||!this.inForeground)||xs(e).Bt().next((e=>void 0===this.dn(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&g("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.Ue=!1,this.mn(),this.je&&(this.je.cancel(),this.je=null),this.gn(),this.yn(),await this.ze.runTransaction("shutdown","readwrite",[tr.store,fr.store],(e=>{const t=new Dr(e,M.I);return this.cn(t).next((()=>this.hn(t)))})),this.ze.close(),this.pn()}dn(e,t){return e.filter((e=>this.fn(e.updateTimeMs,t)&&!this._n(e.clientId)))}Tn(){return this.runTransaction("getActiveClients","readonly",(e=>xs(e).Bt().next((e=>this.dn(e,18e5).map((e=>e.clientId))))))}get started(){return this.Ue}getMutationQueue(e){return ns.Xt(e,this.k,this.Jt,this.referenceDelegate)}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getIndexManager(){return this.Jt}getBundleCache(){return this.Ye}runTransaction(e,t,n){g("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite";let s;return this.ze.runTransaction(e,r,pr,(r=>(s=new Dr(r,this.Be?this.Be.next():M.I),"readwrite-primary"===t?this.rn(s).next((e=>!!e||this.on(s))).next((t=>{if(!t)throw p(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Me.enqueueRetryable((()=>this.We(!1))),new S(b.FAILED_PRECONDITION,yr);return n(s)})).next((e=>this.an(s).next((()=>e)))):this.En(s).next((()=>n(s)))))).then((e=>(s.raiseOnCommittedEvent(),e)))}En(e){return Cs(e).get(tr.key).next((e=>{if(null!==e&&this.fn(e.leaseTimestampMs,5e3)&&!this._n(e.ownerId)&&!this.un(e)&&!(this.Le||this.allowTabSynchronization&&e.allowTabSynchronization))throw new S(b.FAILED_PRECONDITION,Ns)}))}an(e){const t=new tr(this.clientId,this.allowTabSynchronization,Date.now());return Cs(e).put(tr.key,t)}static Pt(){return Tr.Pt()}cn(e){const t=Cs(e);return t.get(tr.key).next((e=>this.un(e)?(g("IndexedDbPersistence","Releasing primary lease."),t.delete(tr.key)):vr.resolve()))}fn(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(p(`Detected an update time that is in the future: ${e} > ${n}`),!1))}tn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ke=()=>{this.Me.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ze())))},this.document.addEventListener("visibilitychange",this.Ke),this.inForeground="visible"===this.document.visibilityState)}gn(){this.Ke&&(this.document.removeEventListener("visibilitychange",this.Ke),this.Ke=null)}en(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.qe=()=>{this.mn(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Me.enterRestrictedMode(!0),this.Me.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.qe))}yn(){this.qe&&(this.window.removeEventListener("pagehide",this.qe),this.qe=null)}_n(e){var t;try{const n=null!==(null===(t=this.Xe)||void 0===t?void 0:t.getItem(this.wn(e)));return g("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return p("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}mn(){if(this.Xe)try{this.Xe.setItem(this.wn(this.clientId),String(Date.now()))}catch(e){p("Failed to set zombie client id.",e)}}pn(){if(this.Xe)try{this.Xe.removeItem(this.wn(this.clientId))}catch(e){}}wn(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Cs(e){return Cr(e,tr.store)}function xs(e){return Cr(e,fr.store)}function Rs(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Ls{constructor(e,t){this.progress=e,this.In=t}}class Ms{constructor(e,t,n){this.Je=e,this.An=t,this.Jt=n}Rn(e,t){return this.An.getAllMutationBatchesAffectingDocumentKey(e,t).next((n=>this.bn(e,t,n)))}bn(e,t,n){return this.Je.getEntry(e,t).next((e=>{for(const t of n)t.applyToLocalView(e);return e}))}Pn(e,t){e.forEach(((e,n)=>{for(const r of t)r.applyToLocalView(n)}))}vn(e,t){return this.Je.getEntries(e,t).next((t=>this.Vn(e,t).next((()=>t))))}Vn(e,t){return this.An.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>this.Pn(t,e)))}getDocumentsMatchingQuery(e,t,n){return function(e){return ce.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.Sn(e,t.path):Ze(t)?this.Dn(e,t,n):this.Cn(e,t,n)}Sn(e,t){return this.Rn(e,new ce(t)).next((e=>{let t=en();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}Dn(e,t,n){const r=t.collectionGroup;let s=en();return this.Jt.getCollectionParents(e,r).next((i=>vr.forEach(i,(i=>{const o=function(e,t){return new ze(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(r));return this.Cn(e,o,n).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}Cn(e,t,n){let r,s;return this.Je.getDocumentsMatchingQuery(e,t,n).next((n=>(r=n,this.An.getAllMutationBatchesAffectingQuery(e,t)))).next((t=>(s=t,this.Nn(e,s,r).next((e=>{r=e;for(const t of s)for(const e of t.mutations){const n=e.key;let s=r.get(n);null==s&&(s=ke.newInvalidDocument(n),r=r.insert(n,s)),Ct(e,s,t.localWriteTime),s.isFoundDocument()||(r=r.remove(n))}}))))).next((()=>(r.forEach(((e,n)=>{ot(t,n)||(r=r.remove(e))})),r)))}Nn(e,t,n){let r=sn();for(const i of t)for(const e of i.mutations)e instanceof Ft&&null===n.get(e.key)&&(r=r.add(e.key));let s=n;return this.Je.getEntries(e,r).next((e=>(e.forEach(((e,t)=>{t.isFoundDocument()&&(s=s.insert(e,t))})),s)))}}class Fs{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.kn=n,this.xn=r}static $n(e,t){let n=sn(),r=sn();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new Fs(e,t.fromCache,n,r)}}class Os{On(e){this.Mn=e}getDocumentsMatchingQuery(e,t,n,r){return function(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}(t)||n.isEqual(B.min())?this.Fn(e,t):this.Mn.vn(e,r).next((s=>{const o=this.Ln(t,s);return(He(t)||Ye(t))&&this.Bn(t.limitType,o,r,n)?this.Fn(e,t):(f()<=i.in.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),it(t)),this.Mn.getDocumentsMatchingQuery(e,t,n).next((e=>(o.forEach((t=>{e=e.insert(t.key,t)})),e))))}))}Ln(e,t){let n=new Ht(at(e));return t.forEach(((t,r)=>{ot(e,r)&&(n=n.add(r))})),n}Bn(e,t,n,r){if(n.size!==t.size)return!0;const s="F"===e?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Fn(e,t){return f()<=i.in.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",it(t)),this.Mn.getDocumentsMatchingQuery(e,t,B.min())}}class Ps{constructor(e,t,n,r){this.persistence=e,this.Un=t,this.k=r,this.qn=new zt(P),this.Kn=new vs((e=>Ne(e)),De),this.jn=B.min(),this.An=e.getMutationQueue(n),this.Qn=e.getRemoteDocumentCache(),this.He=e.getTargetCache(),this.Wn=new Ms(this.Qn,this.An,this.persistence.getIndexManager()),this.Ye=e.getBundleCache(),this.Un.On(this.Wn)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.qn)))}}function Vs(e,t,n,r){return new Ps(e,t,n,r)}async function qs(e,t){const n=E(e);let r=n.An,s=n.Wn;const i=await n.persistence.runTransaction("Handle user change","readonly",(e=>{let i;return n.An.getAllMutationBatches(e).next((o=>(i=o,r=n.persistence.getMutationQueue(t),s=new Ms(n.Qn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(e)))).next((t=>{const n=[],r=[];let o=sn();for(const e of i){n.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){r.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return s.vn(e,o).next((e=>({Gn:e,removedBatchIds:n,addedBatchIds:r})))}))}));return n.An=r,n.Wn=s,n.Un.On(n.Wn),i}function Us(e){const t=E(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.He.getLastRemoteSnapshotVersion(e)))}function Bs(e,t,n,r,s){let i=sn();return n.forEach((e=>i=i.add(e))),t.getEntries(e,i).next((e=>{let i=Xt();return n.forEach(((n,o)=>{const a=e.get(n),c=(null==s?void 0:s.get(n))||r;o.isNoDocument()&&o.version.isEqual(B.min())?(t.removeEntry(n,c),i=i.insert(n,o)):!a.isValidDocument()||o.version.compareTo(a.version)>0||0===o.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(o,c),i=i.insert(n,o)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",o.version)})),i}))}function Ks(e,t){const n=E(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.An.getNextMutationBatchAfterBatchId(e,t))))}function $s(e,t){const n=E(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.He.getTargetData(e,t).next((s=>s?(r=s,vr.resolve(r)):n.He.allocateTargetId(e).next((s=>(r=new Lr(t,s,0,e.currentSequenceNumber),n.He.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.qn.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.qn=n.qn.insert(e.targetId,e),n.Kn.set(t,e.targetId)),e}))}async function js(e,t,n){const r=E(e),s=r.qn.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!Sr(e))throw e;g("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.qn=r.qn.remove(t),r.Kn.delete(s.target)}function Gs(e,t,n){const r=E(e);let s=B.min(),i=sn();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=E(e),s=r.Kn.get(n);return void 0!==s?vr.resolve(r.qn.get(s)):r.He.getTargetData(t,n)}(r,e,tt(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.He.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.Un.getDocumentsMatchingQuery(e,t,n?s:B.min(),n?i:sn()))).next((e=>({documents:e,zn:i})))))}function zs(e,t){const n=E(e),r=E(n.He),s=n.qn.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.Et(e,t).next((e=>e?e.target:null))))}function Qs(e){const t=E(e);return t.persistence.runTransaction("Get new document changes","readonly",(e=>function(e,t,n){const r=E(e);let s=Xt(),i=Pr(n);const o=Ss(t),a=IDBKeyRange.lowerBound(i,!0);return o.jt({index:ar.readTimeIndex,range:a},((e,t)=>{const n=Fr(r.k,t);s=s.insert(n.key,n),i=t.readTime})).next((()=>({In:s,readTime:Vr(i)})))}(t.Qn,e,t.jn))).then((({In:e,readTime:n})=>(t.jn=n,e)))}async function Ws(e,t,n=sn()){const r=await $s(e,tt(jr(t.bundledQuery))),s=E(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=bn(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Ye.saveNamedQuery(e,t);const o=r.withResumeToken(J.EMPTY_BYTE_STRING,i);return s.qn=s.qn.insert(o.targetId,o),s.He.updateTargetData(e,o).next((()=>s.He.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.He.addMatchingKeys(e,n,r.targetId))).next((()=>s.Ye.saveNamedQuery(e,t)))}))}class Hs{constructor(e){this.k=e,this.Xn=new Map,this.Zn=new Map}getBundleMetadata(e,t){return vr.resolve(this.Xn.get(t))}saveBundleMetadata(e,t){var n;return this.Xn.set(t.id,{id:(n=t).id,version:n.version,createTime:bn(n.createTime)}),vr.resolve()}getNamedQuery(e,t){return vr.resolve(this.Zn.get(t))}saveNamedQuery(e,t){return this.Zn.set(t.name,function(e){return{name:e.name,query:jr(e.bundledQuery),readTime:bn(e.readTime)}}(t)),vr.resolve()}}class Ys{constructor(){this.ts=new Ht(Js.es),this.ns=new Ht(Js.ss)}isEmpty(){return this.ts.isEmpty()}addReference(e,t){const n=new Js(e,t);this.ts=this.ts.add(n),this.ns=this.ns.add(n)}rs(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.os(new Js(e,t))}cs(e,t){e.forEach((e=>this.removeReference(e,t)))}us(e){const t=new ce(new z([])),n=new Js(t,e),r=new Js(t,e+1),s=[];return this.ns.forEachInRange([n,r],(e=>{this.os(e),s.push(e.key)})),s}hs(){this.ts.forEach((e=>this.os(e)))}os(e){this.ts=this.ts.delete(e),this.ns=this.ns.delete(e)}ls(e){const t=new ce(new z([])),n=new Js(t,e),r=new Js(t,e+1);let s=sn();return this.ns.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new Js(e,0),n=this.ts.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Js{constructor(e,t){this.key=e,this.fs=t}static es(e,t){return ce.comparator(e.key,t.key)||P(e.fs,t.fs)}static ss(e,t){return P(e.fs,t.fs)||ce.comparator(e.key,t.key)}}class Xs{constructor(e,t){this.Jt=e,this.referenceDelegate=t,this.An=[],this.ds=1,this.ws=new Ht(Js.es)}checkEmpty(e){return vr.resolve(0===this.An.length)}addMutationBatch(e,t,n,r){const s=this.ds;this.ds++,this.An.length>0&&this.An[this.An.length-1];const i=new xr(s,t,n,r);this.An.push(i);for(const o of r)this.ws=this.ws.add(new Js(o.key,s)),this.Jt.addToCollectionParentIndex(e,o.key.path.popLast());return vr.resolve(i)}lookupMutationBatch(e,t){return vr.resolve(this._s(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.gs(n),s=r<0?0:r;return vr.resolve(this.An.length>s?this.An[s]:null)}getHighestUnacknowledgedBatchId(){return vr.resolve(0===this.An.length?-1:this.ds-1)}getAllMutationBatches(e){return vr.resolve(this.An.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Js(t,0),r=new Js(t,Number.POSITIVE_INFINITY),s=[];return this.ws.forEachInRange([n,r],(e=>{const t=this._s(e.fs);s.push(t)})),vr.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ht(P);return t.forEach((e=>{const t=new Js(e,0),r=new Js(e,Number.POSITIVE_INFINITY);this.ws.forEachInRange([t,r],(e=>{n=n.add(e.fs)}))})),vr.resolve(this.ys(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;ce.isDocumentKey(s)||(s=s.child(""));const i=new Js(new ce(s),0);let o=new Ht(P);return this.ws.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.fs)),!0)}),i),vr.resolve(this.ys(o))}ys(e){const t=[];return e.forEach((e=>{const n=this._s(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){I(0===this.ps(t.batchId,"removed")),this.An.shift();let n=this.ws;return vr.forEach(t.mutations,(r=>{const s=new Js(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.ws=n}))}ee(e){}containsKey(e,t){const n=new Js(t,0),r=this.ws.firstAfterOrEqual(n);return vr.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.An.length,vr.resolve()}ps(e,t){return this.gs(e)}gs(e){return 0===this.An.length?0:e-this.An[0].batchId}_s(e){const t=this.gs(e);return t<0||t>=this.An.length?null:this.An[t]}}class Zs{constructor(e,t){this.Jt=e,this.Ts=t,this.docs=new zt(ce.comparator),this.size=0}addEntry(e,t,n){const r=t.key,s=this.docs.get(r),i=s?s.size:0,o=this.Ts(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:o,readTime:n}),this.size+=o-i,this.Jt.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return vr.resolve(n?n.document.mutableCopy():ke.newInvalidDocument(t))}getEntries(e,t){let n=Xt();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():ke.newInvalidDocument(e))})),vr.resolve(n)}getDocumentsMatchingQuery(e,t,n){let r=Xt();const s=new ce(t.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s,readTime:o}}=i.getNext();if(!t.path.isPrefixOf(e.path))break;o.compareTo(n)<=0||ot(t,s)&&(r=r.insert(s.key,s.mutableCopy()))}return vr.resolve(r)}Es(e,t){return vr.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new ei(this)}getSize(e){return vr.resolve(this.size)}}class ei extends Is{constructor(e){super(),this.De=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.document.isValidDocument()?t.push(this.De.addEntry(e,r.document,this.getReadTime(n))):this.De.removeEntry(n)})),vr.waitFor(t)}getFromCache(e,t){return this.De.getEntry(e,t)}getAllFromCache(e,t){return this.De.getEntries(e,t)}}class ti{constructor(e){this.persistence=e,this.Is=new vs((e=>Ne(e)),De),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.As=0,this.Rs=new Ys,this.targetCount=0,this.bs=as.ie()}forEachTarget(e,t){return this.Is.forEach(((e,n)=>t(n))),vr.resolve()}getLastRemoteSnapshotVersion(e){return vr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return vr.resolve(this.As)}allocateTargetId(e){return this.highestTargetId=this.bs.next(),vr.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.As&&(this.As=t),vr.resolve()}ae(e){this.Is.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.bs=new as(t),this.highestTargetId=t),e.sequenceNumber>this.As&&(this.As=e.sequenceNumber)}addTargetData(e,t){return this.ae(t),this.targetCount+=1,vr.resolve()}updateTargetData(e,t){return this.ae(t),vr.resolve()}removeTargetData(e,t){return this.Is.delete(t.target),this.Rs.us(t.targetId),this.targetCount-=1,vr.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Is.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Is.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),vr.waitFor(s).next((()=>r))}getTargetCount(e){return vr.resolve(this.targetCount)}getTargetData(e,t){const n=this.Is.get(t)||null;return vr.resolve(n)}addMatchingKeys(e,t,n){return this.Rs.rs(t,n),vr.resolve()}removeMatchingKeys(e,t,n){this.Rs.cs(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),vr.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Rs.us(t),vr.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Rs.ls(t);return vr.resolve(n)}containsKey(e,t){return vr.resolve(this.Rs.containsKey(t))}}class ni{constructor(e,t){this.Ps={},this.Be=new M(0),this.Ue=!1,this.Ue=!0,this.referenceDelegate=e(this),this.He=new ti(this),this.Jt=new Wr,this.Je=function(e,t){return new Zs(e,t)}(this.Jt,(e=>this.referenceDelegate.vs(e))),this.k=new Mr(t),this.Ye=new Hs(this.k)}start(){return Promise.resolve()}shutdown(){return this.Ue=!1,Promise.resolve()}get started(){return this.Ue}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Jt}getMutationQueue(e){let t=this.Ps[e.toKey()];return t||(t=new Xs(this.Jt,this.referenceDelegate),this.Ps[e.toKey()]=t),t}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getBundleCache(){return this.Ye}runTransaction(e,t,n){g("MemoryPersistence","Starting transaction:",e);const r=new ri(this.Be.next());return this.referenceDelegate.Vs(),n(r).next((e=>this.referenceDelegate.Ss(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Ds(e,t){return vr.or(Object.values(this.Ps).map((n=>()=>n.containsKey(e,t))))}}class ri extends wr{constructor(e){super(),this.currentSequenceNumber=e}}class si{constructor(e){this.persistence=e,this.Cs=new Ys,this.Ns=null}static ks(e){return new si(e)}get xs(){if(this.Ns)return this.Ns;throw v()}addReference(e,t,n){return this.Cs.addReference(n,t),this.xs.delete(n.toString()),vr.resolve()}removeReference(e,t,n){return this.Cs.removeReference(n,t),this.xs.add(n.toString()),vr.resolve()}markPotentiallyOrphaned(e,t){return this.xs.add(t.toString()),vr.resolve()}removeTarget(e,t){this.Cs.us(t.targetId).forEach((e=>this.xs.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.xs.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Vs(){this.Ns=new Set}Ss(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return vr.forEach(this.xs,(n=>{const r=ce.fromPath(n);return this.$s(e,r).next((e=>{e||t.removeEntry(r)}))})).next((()=>(this.Ns=null,t.apply(e))))}updateLimboDocument(e,t){return this.$s(e,t).next((e=>{e?this.xs.delete(t.toString()):this.xs.add(t.toString())}))}vs(e){return 0}$s(e,t){return vr.or([()=>vr.resolve(this.Cs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ds(e,t)])}}function ii(e,t){return`firestore_clients_${e}_${t}`}function oi(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function ai(e,t){return`firestore_targets_${e}_${t}`}class ci{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Os(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new S(r.error.code,r.error.message))),i?new ci(e,t,r.state,s):(p("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Ms(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ui{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Os(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new S(n.error.code,n.error.message))),s?new ui(e,n.state,r):(p("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Ms(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class hi{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Os(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=an();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=ae(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new hi(e,s):(p("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class li{constructor(e,t){this.clientId=e,this.onlineState=t}static Os(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new li(t.clientId,t.onlineState):(p("SharedClientState",`Failed to parse online state: ${e}`),null)}}class di{constructor(){this.activeTargetIds=an()}Fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}Ls(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Ms(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class fi{constructor(e,t,n,r,s){this.window=e,this.Me=t,this.persistenceKey=n,this.Bs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Us=this.qs.bind(this),this.Ks=new zt(P),this.started=!1,this.js=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Qs=ii(this.persistenceKey,this.Bs),this.Ws=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.Ks=this.Ks.insert(this.Bs,new di),this.Gs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.zs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Hs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Js=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Ys=function(e){return`firestore_bundle_loaded_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.Us)}static Pt(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Tn();for(const n of e){if(n===this.Bs)continue;const e=this.getItem(ii(this.persistenceKey,n));if(e){const t=hi.Os(n,e);t&&(this.Ks=this.Ks.insert(t.clientId,t))}}this.Xs();const t=this.storage.getItem(this.Js);if(t){const e=this.Zs(t);e&&this.ti(e)}for(const n of this.js)this.qs(n);this.js=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ws,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ei(this.Ks)}isActiveQueryTarget(e){let t=!1;return this.Ks.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.ni(e,"pending")}updateMutationState(e,t,n){this.ni(e,t,n),this.si(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(ai(this.persistenceKey,e));if(n){const r=ui.Os(e,n);r&&(t=r.state)}}return this.ii.Fs(e),this.Xs(),t}removeLocalQueryTarget(e){this.ii.Ls(e),this.Xs()}isLocalQueryTarget(e){return this.ii.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(ai(this.persistenceKey,e))}updateQueryState(e,t,n){this.ri(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.si(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.oi(e)}notifyBundleLoaded(){this.ci()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Us),this.removeItem(this.Qs),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return g("SharedClientState","READ",e,t),t}setItem(e,t){g("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){g("SharedClientState","REMOVE",e),this.storage.removeItem(e)}qs(e){const t=e;if(t.storageArea===this.storage){if(g("SharedClientState","EVENT",t.key,t.newValue),t.key===this.Qs)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Me.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.Gs.test(t.key)){if(null==t.newValue){const e=this.ai(t.key);return this.ui(e,null)}{const e=this.hi(t.key,t.newValue);if(e)return this.ui(e.clientId,e)}}else if(this.zs.test(t.key)){if(null!==t.newValue){const e=this.li(t.key,t.newValue);if(e)return this.fi(e)}}else if(this.Hs.test(t.key)){if(null!==t.newValue){const e=this.di(t.key,t.newValue);if(e)return this.wi(e)}}else if(t.key===this.Js){if(null!==t.newValue){const e=this.Zs(t.newValue);if(e)return this.ti(e)}}else if(t.key===this.Ws){const e=function(e){let t=M.I;if(null!=e)try{const n=JSON.parse(e);I("number"==typeof n),t=n}catch(e){p("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==M.I&&this.sequenceNumberHandler(e)}else if(t.key===this.Ys)return this.syncEngine._i()}else this.js.push(t)}))}}get ii(){return this.Ks.get(this.Bs)}Xs(){this.setItem(this.Qs,this.ii.Ms())}ni(e,t,n){const r=new ci(this.currentUser,e,t,n),s=oi(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Ms())}si(e){const t=oi(this.persistenceKey,this.currentUser,e);this.removeItem(t)}oi(e){const t={clientId:this.Bs,onlineState:e};this.storage.setItem(this.Js,JSON.stringify(t))}ri(e,t,n){const r=ai(this.persistenceKey,e),s=new ui(e,t,n);this.setItem(r,s.Ms())}ci(){this.setItem(this.Ys,"value-not-used")}ai(e){const t=this.Gs.exec(e);return t?t[1]:null}hi(e,t){const n=this.ai(e);return hi.Os(n,t)}li(e,t){const n=this.zs.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return ci.Os(new h(s),r,t)}di(e,t){const n=this.Hs.exec(e),r=Number(n[1]);return ui.Os(r,t)}Zs(e){return li.Os(e)}async fi(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.mi(e.batchId,e.state,e.error);g("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}wi(e){return this.syncEngine.gi(e.targetId,e.state,e.error)}ui(e,t){const n=t?this.Ks.insert(e,t):this.Ks.remove(e),r=this.ei(this.Ks),s=this.ei(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.yi(i,o).then((()=>{this.Ks=n}))}ti(e){this.Ks.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ei(e){let t=an();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class mi{constructor(){this.pi=new di,this.Ti={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.pi.Fs(e),this.Ti[e]||"not-current"}updateQueryState(e,t,n){this.Ti[e]=t}removeLocalQueryTarget(e){this.pi.Ls(e)}isLocalQueryTarget(e){return this.pi.activeTargetIds.has(e)}clearQueryState(e){delete this.Ti[e]}getAllActiveQueryTargets(){return this.pi.activeTargetIds}isActiveQueryTarget(e){return this.pi.activeTargetIds.has(e)}start(){return this.pi=new di,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(){}}class gi{Ei(e){}shutdown(){}}class pi{constructor(){this.Ii=()=>this.Ai(),this.Ri=()=>this.bi(),this.Pi=[],this.vi()}Ei(e){this.Pi.push(e)}shutdown(){window.removeEventListener("online",this.Ii),window.removeEventListener("offline",this.Ri)}vi(){window.addEventListener("online",this.Ii),window.addEventListener("offline",this.Ri)}Ai(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Pi)e(0)}bi(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Pi)e(1)}static Pt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const yi={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class wi{constructor(e){this.Vi=e.Vi,this.Si=e.Si}Di(e){this.Ci=e}Ni(e){this.ki=e}onMessage(e){this.xi=e}close(){this.Si()}send(e){this.Vi(e)}$i(){this.Ci()}Oi(e){this.ki(e)}Mi(e){this.xi(e)}}class vi extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.Fi=t+"://"+e.host,this.Li="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Bi(e,t,n,r,s){const i=this.Ui(e,t);g("RestConnection","Sending: ",i,n);const o={};return this.qi(o,r,s),this.Ki(e,i,o,n).then((e=>(g("RestConnection","Received: ",e),e)),(t=>{throw y("RestConnection",`${e} failed with error: `,t,"url: ",i,"request:",n),t}))}ji(e,t,n,r,s){return this.Bi(e,t,n,r,s)}qi(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+l,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}Ui(e,t){const n=yi[e];return`${this.Fi}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}Ki(e,t,n,r){return new Promise(((s,i)=>{const o=new a.JJ;o.listenOnce(a.tw.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.jK.NO_ERROR:const t=o.getResponseJson();g("Connection","XHR received:",JSON.stringify(t)),s(t);break;case a.jK.TIMEOUT:g("Connection",'RPC "'+e+'" timed out'),i(new S(b.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=o.getStatus();if(g("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const e=o.getResponseJson().error;if(e&&e.status&&e.message){const t=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(b).indexOf(t)>=0?t:b.UNKNOWN}(e.status);i(new S(t,e.message))}else i(new S(b.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new S(b.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g("Connection",'RPC "'+e+'" completed.')}}));const c=JSON.stringify(r);o.send(t,"POST",c,n,15)}))}Qi(e,t,n){const r=[this.Fi,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=(0,a.UE)(),i=(0,a.FJ)(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(c.xmlHttpFactory=new a.zI({})),this.qi(c.initMessageHeaders,t,n),(0,o.uI)()||(0,o.b$)()||(0,o.d)()||(0,o.w1)()||(0,o.Mn)()||(0,o.ru)()||(c.httpHeadersOverwriteParam="$httpHeaders");const u=r.join("");g("Connection","Creating WebChannel: "+u,c);const h=s.createWebChannel(u,c);let l=!1,d=!1;const f=new wi({Vi:e=>{d?g("Connection","Not sending because WebChannel is closed:",e):(l||(g("Connection","Opening WebChannel transport."),h.open(),l=!0),g("Connection","WebChannel sending:",e),h.send(e))},Si:()=>h.close()}),m=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return m(h,a.ii.EventType.OPEN,(()=>{d||g("Connection","WebChannel transport opened.")})),m(h,a.ii.EventType.CLOSE,(()=>{d||(d=!0,g("Connection","WebChannel transport closed"),f.Oi())})),m(h,a.ii.EventType.ERROR,(e=>{d||(d=!0,y("Connection","WebChannel transport errored:",e),f.Oi(new S(b.UNAVAILABLE,"The operation could not be completed")))})),m(h,a.ii.EventType.MESSAGE,(e=>{var t;if(!d){const n=e.data[0];I(!!n);const r=n,s=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(s){g("Connection","WebChannel received error:",s);const e=s.status;let t=function(e){const t=Kt[e];if(void 0!==t)return Gt(t)}(e),n=s.message;void 0===t&&(t=b.INTERNAL,n="Unknown error status: "+e+" with message "+s.message),d=!0,f.Oi(new S(t,n)),h.close()}else g("Connection","WebChannel received:",n),f.Mi(n)}})),m(i,a.ju.STAT_EVENT,(e=>{e.stat===a.kN.PROXY?g("Connection","Detected buffering proxy"):e.stat===a.kN.NOPROXY&&g("Connection","Detected no buffering proxy")})),setTimeout((()=>{f.$i()}),0),f}}function Ii(){return"undefined"!=typeof window?window:null}function Ti(){return"undefined"!=typeof document?document:null}function Ei(e){return new vn(e,!0)}class bi{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Me=e,this.timerId=t,this.Wi=n,this.Gi=r,this.zi=s,this.Hi=0,this.Ji=null,this.Yi=Date.now(),this.reset()}reset(){this.Hi=0}Xi(){this.Hi=this.zi}Zi(e){this.cancel();const t=Math.floor(this.Hi+this.tr()),n=Math.max(0,Date.now()-this.Yi),r=Math.max(0,t-n);r>0&&g("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Hi} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Ji=this.Me.enqueueAfterDelay(this.timerId,r,(()=>(this.Yi=Date.now(),e()))),this.Hi*=this.Gi,this.Hi<this.Wi&&(this.Hi=this.Wi),this.Hi>this.zi&&(this.Hi=this.zi)}er(){null!==this.Ji&&(this.Ji.skipDelay(),this.Ji=null)}cancel(){null!==this.Ji&&(this.Ji.cancel(),this.Ji=null)}tr(){return(Math.random()-.5)*this.Hi}}class Si{constructor(e,t,n,r,s,i,o,a){this.Me=e,this.nr=n,this.sr=r,this.ir=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.rr=0,this.cr=null,this.ar=null,this.stream=null,this.ur=new bi(e,t)}hr(){return 1===this.state||5===this.state||this.lr()}lr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.dr()}async stop(){this.hr()&&await this.close(0)}wr(){this.state=0,this.ur.reset()}_r(){this.lr()&&null===this.cr&&(this.cr=this.Me.enqueueAfterDelay(this.nr,6e4,(()=>this.mr())))}gr(e){this.yr(),this.stream.send(e)}async mr(){if(this.lr())return this.close(0)}yr(){this.cr&&(this.cr.cancel(),this.cr=null)}pr(){this.ar&&(this.ar.cancel(),this.ar=null)}async close(e,t){this.yr(),this.pr(),this.ur.cancel(),this.rr++,4!==e?this.ur.reset():t&&t.code===b.RESOURCE_EXHAUSTED?(p(t.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.ur.Xi()):t&&t.code===b.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Tr(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Ni(t)}Tr(){}auth(){this.state=1;const e=this.Er(this.rr),t=this.rr;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.rr===t&&this.Ir(e,n)}),(t=>{e((()=>{const e=new S(b.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Ar(e)}))}))}Ir(e,t){const n=this.Er(this.rr);this.stream=this.Rr(e,t),this.stream.Di((()=>{n((()=>(this.state=2,this.ar=this.Me.enqueueAfterDelay(this.sr,1e4,(()=>(this.lr()&&(this.state=3),Promise.resolve()))),this.listener.Di())))})),this.stream.Ni((e=>{n((()=>this.Ar(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}dr(){this.state=5,this.ur.Zi((async()=>{this.state=0,this.start()}))}Ar(e){return g("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Er(e){return t=>{this.Me.enqueueAndForget((()=>this.rr===e?t():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class ki extends Si{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.k=s}Rr(e,t){return this.ir.Qi("Listen",e,t)}onMessage(e){this.ur.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:v()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.C?(I(void 0===t||"string"==typeof t),J.fromBase64String(t||"")):(I(void 0===t||t instanceof Uint8Array),J.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?b.UNKNOWN:Gt(e.code);return new S(t,e.message||"")}(o);n=new dn(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=An(e,r.document.name),i=bn(r.document.updateTime),o=new be({mapValue:{fields:r.document.fields}}),a=ke.newFoundDocument(s,i,o),c=r.targetIds||[],u=r.removedTargetIds||[];n=new hn(c,u,a.key,a)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=An(e,r.document),i=r.readTime?bn(r.readTime):B.min(),o=ke.newNoDocument(s,i),a=r.removedTargetIds||[];n=new hn([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=An(e,r.document),i=r.removedTargetIds||[];n=new hn([],i,s,null)}else{if(!("filter"in t))return v();{t.filter;const e=t.filter;e.targetId;const r=e.count||0,s=new Bt(r),i=e.targetId;n=new ln(i,s)}}return n}(this.k,e),n=function(e){if(!("targetChange"in e))return B.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?B.min():t.readTime?bn(t.readTime):B.min()}(e);return this.listener.br(t,n)}Pr(e){const t={};t.database=Cn(this.k),t.addTarget=function(e,t){let n;const r=t.target;return n=Ce(r)?{documents:On(e,r)}:{query:Pn(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=Tn(e,t.resumeToken):t.snapshotVersion.compareTo(B.min())>0&&(n.readTime=In(e,t.snapshotVersion.toTimestamp())),n}(this.k,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return v()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.k,e);n&&(t.labels=n),this.gr(t)}vr(e){const t={};t.database=Cn(this.k),t.removeTarget=e,this.gr(t)}}class _i extends Si{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.k=s,this.Vr=!1}get Sr(){return this.Vr}start(){this.Vr=!1,this.lastStreamToken=void 0,super.start()}Tr(){this.Vr&&this.Dr([])}Rr(e,t){return this.ir.Qi("Write",e,t)}onMessage(e){if(I(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Vr){this.ur.reset();const t=function(e,t){return e&&e.length>0?(I(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?bn(e.updateTime):bn(t);return n.isEqual(B.min())&&(n=bn(t)),new kt(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=bn(e.commitTime);return this.listener.Cr(n,t)}return I(!e.writeResults||0===e.writeResults.length),this.Vr=!0,this.listener.Nr()}kr(){const e={};e.database=Cn(this.k),this.gr(e)}Dr(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Mn(this.k,e)))};this.gr(t)}}class Ai extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.ir=n,this.k=r,this.$r=!1}Or(){if(this.$r)throw new S(b.FAILED_PRECONDITION,"The client has already been terminated.")}Bi(e,t,n){return this.Or(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.ir.Bi(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===b.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(b.UNKNOWN,e.toString())}))}ji(e,t,n){return this.Or(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.ir.ji(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===b.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(b.UNKNOWN,e.toString())}))}terminate(){this.$r=!0}}class Ni{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.Mr=0,this.Fr=null,this.Lr=!0}Br(){0===this.Mr&&(this.Ur("Unknown"),this.Fr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.Fr=null,this.qr("Backend didn't respond within 10 seconds."),this.Ur("Offline"),Promise.resolve()))))}Kr(e){"Online"===this.state?this.Ur("Unknown"):(this.Mr++,this.Mr>=1&&(this.jr(),this.qr(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.Ur("Offline")))}set(e){this.jr(),this.Mr=0,"Online"===e&&(this.Lr=!1),this.Ur(e)}Ur(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}qr(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Lr?(p(t),this.Lr=!1):g("OnlineStateTracker",t)}jr(){null!==this.Fr&&(this.Fr.cancel(),this.Fr=null)}}class Di{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Qr=[],this.Wr=new Map,this.Gr=new Set,this.zr=[],this.Hr=s,this.Hr.Ei((e=>{n.enqueueAndForget((async()=>{Vi(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=E(e);t.Gr.add(4),await xi(t),t.Jr.set("Unknown"),t.Gr.delete(4),await Ci(t)}(this))}))})),this.Jr=new Ni(n,r)}}async function Ci(e){if(Vi(e))for(const t of e.zr)await t(!0)}async function xi(e){for(const t of e.zr)await t(!1)}function Ri(e,t){const n=E(e);n.Wr.has(t.targetId)||(n.Wr.set(t.targetId,t),Pi(n)?Oi(n):no(n).lr()&&Mi(n,t))}function Li(e,t){const n=E(e),r=no(n);n.Wr.delete(t),r.lr()&&Fi(n,t),0===n.Wr.size&&(r.lr()?r._r():Vi(n)&&n.Jr.set("Unknown"))}function Mi(e,t){e.Yr.X(t.targetId),no(e).Pr(t)}function Fi(e,t){e.Yr.X(t),no(e).vr(t)}function Oi(e){e.Yr=new mn({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>e.Wr.get(t)||null}),no(e).start(),e.Jr.Br()}function Pi(e){return Vi(e)&&!no(e).hr()&&e.Wr.size>0}function Vi(e){return 0===E(e).Gr.size}function qi(e){e.Yr=void 0}async function Ui(e){e.Wr.forEach(((t,n)=>{Mi(e,t)}))}async function Bi(e,t){qi(e),Pi(e)?(e.Jr.Kr(t),Oi(e)):e.Jr.set("Unknown")}async function Ki(e,t,n){if(e.Jr.set("Online"),t instanceof dn&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.Wr.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Wr.delete(r),e.Yr.removeTarget(r))}(e,t)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await $i(e,n)}else if(t instanceof hn?e.Yr.ot(t):t instanceof ln?e.Yr.dt(t):e.Yr.ut(t),!n.isEqual(B.min()))try{const t=await Us(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.Yr.gt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.Wr.get(r);s&&e.Wr.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.Wr.get(t);if(!n)return;e.Wr.set(t,n.withResumeToken(J.EMPTY_BYTE_STRING,n.snapshotVersion)),Fi(e,t);const r=new Lr(n.target,t,1,n.sequenceNumber);Mi(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){g("RemoteStore","Failed to raise snapshot:",t),await $i(e,t)}}async function $i(e,t,n){if(!Sr(t))throw t;e.Gr.add(1),await xi(e),e.Jr.set("Offline"),n||(n=()=>Us(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),e.Gr.delete(1),await Ci(e)}))}function ji(e,t){return t().catch((n=>$i(e,n,t)))}async function Gi(e){const t=E(e),n=ro(t);let r=t.Qr.length>0?t.Qr[t.Qr.length-1].batchId:-1;for(;zi(t);)try{const e=await Ks(t.localStore,r);if(null===e){0===t.Qr.length&&n._r();break}r=e.batchId,Qi(t,e)}catch(e){await $i(t,e)}Wi(t)&&Hi(t)}function zi(e){return Vi(e)&&e.Qr.length<10}function Qi(e,t){e.Qr.push(t);const n=ro(e);n.lr()&&n.Sr&&n.Dr(t.mutations)}function Wi(e){return Vi(e)&&!ro(e).hr()&&e.Qr.length>0}function Hi(e){ro(e).start()}async function Yi(e){ro(e).kr()}async function Ji(e){const t=ro(e);for(const n of e.Qr)t.Dr(n.mutations)}async function Xi(e,t,n){const r=e.Qr.shift(),s=Rr.from(r,t,n);await ji(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await Gi(e)}async function Zi(e,t){t&&ro(e).Sr&&await async function(e,t){if(jt(n=t.code)&&n!==b.ABORTED){const n=e.Qr.shift();ro(e).wr(),await ji(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Gi(e)}var n}(e,t),Wi(e)&&Hi(e)}async function eo(e,t){const n=E(e);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const r=Vi(n);n.Gr.add(3),await xi(n),r&&n.Jr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.Gr.delete(3),await Ci(n)}async function to(e,t){const n=E(e);t?(n.Gr.delete(2),await Ci(n)):t||(n.Gr.add(2),await xi(n),n.Jr.set("Unknown"))}function no(e){return e.Xr||(e.Xr=function(e,t,n){const r=E(e);return r.Or(),new ki(t,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(e.datastore,e.asyncQueue,{Di:Ui.bind(null,e),Ni:Bi.bind(null,e),br:Ki.bind(null,e)}),e.zr.push((async t=>{t?(e.Xr.wr(),Pi(e)?Oi(e):e.Jr.set("Unknown")):(await e.Xr.stop(),qi(e))}))),e.Xr}function ro(e){return e.Zr||(e.Zr=function(e,t,n){const r=E(e);return r.Or(),new _i(t,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(e.datastore,e.asyncQueue,{Di:Yi.bind(null,e),Ni:Zi.bind(null,e),Nr:Ji.bind(null,e),Cr:Xi.bind(null,e)}),e.zr.push((async t=>{t?(e.Zr.wr(),await Gi(e)):(await e.Zr.stop(),e.Qr.length>0&&(g("RemoteStore",`Stopping write stream with ${e.Qr.length} pending writes`),e.Qr=[]))}))),e.Zr}class so{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new k,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new so(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(b.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function io(e,t){if(p("AsyncQueue",`${t}: ${e}`),Sr(e))return new S(b.UNAVAILABLE,`${t}: ${e}`);throw e}class oo{constructor(e){this.comparator=e?(t,n)=>e(t,n)||ce.comparator(t.key,n.key):(e,t)=>ce.comparator(e.key,t.key),this.keyedMap=en(),this.sortedSet=new zt(this.comparator)}static emptySet(e){return new oo(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof oo))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new oo;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ao{constructor(){this.eo=new zt(ce.comparator)}track(e){const t=e.doc.key,n=this.eo.get(t);n?0!==e.type&&3===n.type?this.eo=this.eo.insert(t,e):3===e.type&&1!==n.type?this.eo=this.eo.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.eo=this.eo.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.eo=this.eo.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.eo=this.eo.remove(t):1===e.type&&2===n.type?this.eo=this.eo.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.eo=this.eo.insert(t,{type:2,doc:e.doc}):v():this.eo=this.eo.insert(t,e)}no(){const e=[];return this.eo.inorderTraversal(((t,n)=>{e.push(n)})),e}}class co{constructor(e,t,n,r,s,i,o,a){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(e,t,n,r){const s=[];return t.forEach((e=>{s.push({type:0,doc:e})})),new co(e,t,oo.emptySet(t),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&rt(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class uo{constructor(){this.so=void 0,this.listeners=[]}}class ho{constructor(){this.queries=new vs((e=>st(e)),rt),this.onlineState="Unknown",this.io=new Set}}async function lo(e,t){const n=E(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new uo),s)try{i.so=await n.onListen(r)}catch(e){const n=io(e,`Initialization of query '${it(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.ro(n.onlineState),i.so&&t.oo(i.so)&&po(n)}async function fo(e,t){const n=E(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function mo(e,t){const n=E(e);let r=!1;for(const s of t){const e=s.query,t=n.queries.get(e);if(t){for(const e of t.listeners)e.oo(s)&&(r=!0);t.so=s}}r&&po(n)}function go(e,t,n){const r=E(e),s=r.queries.get(t);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(t)}function po(e){e.io.forEach((e=>{e.next()}))}class yo{constructor(e,t,n){this.query=e,this.co=t,this.ao=!1,this.uo=null,this.onlineState="Unknown",this.options=n||{}}oo(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new co(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.ao?this.ho(e)&&(this.co.next(e),t=!0):this.lo(e,this.onlineState)&&(this.fo(e),t=!0),this.uo=e,t}onError(e){this.co.error(e)}ro(e){this.onlineState=e;let t=!1;return this.uo&&!this.ao&&this.lo(this.uo,e)&&(this.fo(this.uo),t=!0),t}lo(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.wo||!n)&&(!e.docs.isEmpty()||"Offline"===t)}ho(e){if(e.docChanges.length>0)return!0;const t=this.uo&&this.uo.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}fo(e){e=co.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.ao=!0,this.co.next(e)}}class wo{constructor(e,t){this.payload=e,this.byteLength=t}_o(){return"metadata"in this.payload}}class vo{constructor(e){this.k=e}Hn(e){return An(this.k,e)}Jn(e){return e.metadata.exists?Ln(this.k,e.document,!1):ke.newNoDocument(this.Hn(e.metadata.name),this.Yn(e.metadata.readTime))}Yn(e){return bn(e)}}class Io{constructor(e,t,n){this.mo=e,this.localStore=t,this.k=n,this.queries=[],this.documents=[],this.progress=To(e)}yo(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;return e.payload.namedQuery?this.queries.push(e.payload.namedQuery):e.payload.documentMetadata?(this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t):e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t),t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}po(e){const t=new Map,n=new vo(this.k);for(const r of e)if(r.metadata.queries){const e=n.Hn(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||sn()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=E(e);let i=sn(),o=Xt(),a=nn();for(const h of n){const e=t.Hn(h.metadata.name);h.document&&(i=i.add(e)),o=o.insert(e,t.Jn(h)),a=a.insert(e,t.Yn(h.metadata.readTime))}const c=s.Qn.newChangeBuffer({trackRemovals:!0}),u=await $s(s,function(e){return tt(We(z.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Bs(e,c,o,B.min(),a).next((t=>(c.apply(e),t))).next((t=>s.He.removeMatchingKeysForTargetId(e,u.targetId).next((()=>s.He.addMatchingKeys(e,i,u.targetId))).next((()=>s.Wn.Vn(e,t))).next((()=>t))))))}(this.localStore,new vo(this.k),this.documents,this.mo.id),t=this.po(this.documents);for(const n of this.queries)await Ws(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",new Ls(Object.assign({},this.progress),e)}}function To(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Eo{constructor(e){this.key=e}}class bo{constructor(e){this.key=e}}class So{constructor(e,t){this.query=e,this.To=t,this.Eo=null,this.current=!1,this.Io=sn(),this.mutatedKeys=sn(),this.Ao=at(e),this.Ro=new oo(this.Ao)}get bo(){return this.To}Po(e,t){const n=t?t.vo:new ao,r=t?t.Ro:this.Ro;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a=He(this.query)&&r.size===this.query.limit?r.last():null,c=Ye(this.query)&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),h=ot(this.query,t)?t:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Vo(u,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Ao(h,a)>0||c&&this.Ao(h,c)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(h?(i=i.add(h),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),He(this.query)||Ye(this.query))for(;i.size>this.query.limit;){const e=He(this.query)?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{Ro:i,vo:n,Bn:o,mutatedKeys:s}}Vo(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.Ro;this.Ro=e.Ro,this.mutatedKeys=e.mutatedKeys;const s=e.vo.no();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(e)-n(t)}(e.type,t.type)||this.Ao(e.doc,t.doc))),this.So(n);const i=t?this.Do():[],o=0===this.Io.size&&this.current?1:0,a=o!==this.Eo;return this.Eo=o,0!==s.length||a?{snapshot:new co(this.query,e.Ro,r,s,e.mutatedKeys,0===o,a,!1),Co:i}:{Co:i}}ro(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ro:this.Ro,vo:new ao,mutatedKeys:this.mutatedKeys,Bn:!1},!1)):{Co:[]}}No(e){return!this.To.has(e)&&!!this.Ro.has(e)&&!this.Ro.get(e).hasLocalMutations}So(e){e&&(e.addedDocuments.forEach((e=>this.To=this.To.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.To=this.To.delete(e))),this.current=e.current)}Do(){if(!this.current)return[];const e=this.Io;this.Io=sn(),this.Ro.forEach((e=>{this.No(e.key)&&(this.Io=this.Io.add(e.key))}));const t=[];return e.forEach((e=>{this.Io.has(e)||t.push(new bo(e))})),this.Io.forEach((n=>{e.has(n)||t.push(new Eo(n))})),t}ko(e){this.To=e.zn,this.Io=sn();const t=this.Po(e.documents);return this.applyChanges(t,!0)}xo(){return co.fromInitialDocuments(this.query,this.Ro,this.mutatedKeys,0===this.Eo)}}class ko{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class _o{constructor(e){this.key=e,this.$o=!1}}class Ao{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Oo={},this.Mo=new vs((e=>st(e)),rt),this.Fo=new Map,this.Lo=new Set,this.Bo=new zt(ce.comparator),this.Uo=new Map,this.qo=new Ys,this.Ko={},this.jo=new Map,this.Qo=as.re(),this.onlineState="Unknown",this.Wo=void 0}get isPrimaryClient(){return!0===this.Wo}}async function No(e,t){const n=ea(e);let r,s;const i=n.Mo.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.xo();else{const e=await $s(n.localStore,tt(t)),i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await Do(n,t,r,"current"===i),n.isPrimaryClient&&Ri(n.remoteStore,e)}return s}async function Do(e,t,n,r){e.Go=(t,n,r)=>async function(e,t,n,r){let s=t.view.Po(n);s.Bn&&(s=await Gs(e.localStore,t.query,!1).then((({documents:e})=>t.view.Po(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(s,e.isPrimaryClient,i);return Uo(e,t.targetId,o.Co),o.snapshot}(e,t,n,r);const s=await Gs(e.localStore,t,!0),i=new So(t,s.zn),o=i.Po(s.documents),a=un.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState),c=i.applyChanges(o,e.isPrimaryClient,a);Uo(e,n,c.Co);const u=new ko(t,n,i);return e.Mo.set(t,u),e.Fo.has(n)?e.Fo.get(n).push(t):e.Fo.set(n,[t]),c.snapshot}async function Co(e,t){const n=E(e),r=n.Mo.get(t),s=n.Fo.get(r.targetId);if(s.length>1)return n.Fo.set(r.targetId,s.filter((e=>!rt(e,t)))),void n.Mo.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await js(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Li(n.remoteStore,r.targetId),Vo(n,r.targetId)})).catch(ds)):(Vo(n,r.targetId),await js(n.localStore,r.targetId,!0))}async function xo(e,t){const n=E(e);try{const e=await function(e,t){const n=E(e),r=t.snapshotVersion;let s=n.qn;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Qn.newChangeBuffer({trackRemovals:!0});s=n.qn;const o=[];t.targetChanges.forEach(((i,a)=>{const c=s.get(a);if(!c)return;o.push(n.He.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.He.addMatchingKeys(e,i.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?u=u.withResumeToken(J.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,r)),s=s.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.He.updateTargetData(e,u))}));let a=Xt();if(t.documentUpdates.forEach(((r,s)=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(Bs(e,i,t.documentUpdates,r,void 0).next((e=>{a=e}))),!r.isEqual(B.min())){const t=n.He.getLastRemoteSnapshotVersion(e).next((t=>n.He.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return vr.waitFor(o).next((()=>i.apply(e))).next((()=>n.Wn.Vn(e,a))).next((()=>a))})).then((e=>(n.qn=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.Uo.get(t);r&&(I(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.$o=!0:e.modifiedDocuments.size>0?I(r.$o):e.removedDocuments.size>0&&(I(r.$o),r.$o=!1))})),await $o(n,e,t)}catch(e){await ds(e)}}function Ro(e,t,n){const r=E(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.Mo.forEach(((n,r)=>{const s=r.view.ro(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=E(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const s of n.listeners)s.ro(t)&&(r=!0)})),r&&po(n)}(r.eventManager,t),e.length&&r.Oo.br(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function Lo(e,t,n){const r=E(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Uo.get(t),i=s&&s.key;if(i){let e=new zt(ce.comparator);e=e.insert(i,ke.newNoDocument(i,B.min()));const n=sn().add(i),s=new cn(B.min(),new Map,new Ht(P),e,n);await xo(r,s),r.Bo=r.Bo.remove(i),r.Uo.delete(t),Ko(r)}else await js(r.localStore,t,!1).then((()=>Vo(r,t,n))).catch(ds)}async function Mo(e,t){const n=E(e),r=t.batch.batchId;try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.Qn.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=vr.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);I(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&r.addEntry(t,n.commitVersion))}))})),o.next((()=>e.An.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.An.performConsistencyCheck(e))).next((()=>n.Wn.vn(e,r)))}))}(n.localStore,t);Po(n,r,null),Oo(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await $o(n,e)}catch(e){await ds(e)}}async function Fo(e,t,n){const r=E(e);try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.An.lookupMutationBatch(e,t).next((t=>(I(null!==t),r=t.keys(),n.An.removeMutationBatch(e,t)))).next((()=>n.An.performConsistencyCheck(e))).next((()=>n.Wn.vn(e,r)))}))}(r.localStore,t);Po(r,t,n),Oo(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await $o(r,e)}catch(n){await ds(n)}}function Oo(e,t){(e.jo.get(t)||[]).forEach((e=>{e.resolve()})),e.jo.delete(t)}function Po(e,t,n){const r=E(e);let s=r.Ko[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Ko[r.currentUser.toKey()]=s}}function Vo(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Fo.get(t))e.Mo.delete(r),n&&e.Oo.zo(r,n);e.Fo.delete(t),e.isPrimaryClient&&e.qo.us(t).forEach((t=>{e.qo.containsKey(t)||qo(e,t)}))}function qo(e,t){e.Lo.delete(t.path.canonicalString());const n=e.Bo.get(t);null!==n&&(Li(e.remoteStore,n),e.Bo=e.Bo.remove(t),e.Uo.delete(n),Ko(e))}function Uo(e,t,n){for(const r of n)r instanceof Eo?(e.qo.addReference(r.key,t),Bo(e,r)):r instanceof bo?(g("SyncEngine","Document no longer in limbo: "+r.key),e.qo.removeReference(r.key,t),e.qo.containsKey(r.key)||qo(e,r.key)):v()}function Bo(e,t){const n=t.key,r=n.path.canonicalString();e.Bo.get(n)||e.Lo.has(r)||(g("SyncEngine","New document in limbo: "+n),e.Lo.add(r),Ko(e))}function Ko(e){for(;e.Lo.size>0&&e.Bo.size<e.maxConcurrentLimboResolutions;){const t=e.Lo.values().next().value;e.Lo.delete(t);const n=new ce(z.fromString(t)),r=e.Qo.next();e.Uo.set(r,new _o(n)),e.Bo=e.Bo.insert(n,r),Ri(e.remoteStore,new Lr(tt(We(n.path)),r,2,M.I))}}async function $o(e,t,n){const r=E(e),s=[],i=[],o=[];r.Mo.isEmpty()||(r.Mo.forEach(((e,a)=>{o.push(r.Go(a,t,n).then((e=>{if(e){r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,e.fromCache?"not-current":"current"),s.push(e);const t=Fs.$n(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.Oo.br(s),await async function(e,t){const n=E(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>vr.forEach(t,(t=>vr.forEach(t.kn,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>vr.forEach(t.xn,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!Sr(e))throw e;g("LocalStore","Failed to update sequence numbers: "+e)}for(const r of t){const e=r.targetId;if(!r.fromCache){const t=n.qn.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.qn=n.qn.insert(e,s)}}}(r.localStore,i))}async function jo(e,t){const n=E(e);if(!n.currentUser.isEqual(t)){g("SyncEngine","User change. New user:",t.toKey());const e=await qs(n.localStore,t);n.currentUser=t,function(e,t){e.jo.forEach((e=>{e.forEach((e=>{e.reject(new S(b.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.jo.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await $o(n,e.Gn)}}function Go(e,t){const n=E(e),r=n.Uo.get(t);if(r&&r.$o)return sn().add(r.key);{let e=sn();const r=n.Fo.get(t);if(!r)return e;for(const t of r){const r=n.Mo.get(t);e=e.unionWith(r.view.bo)}return e}}async function zo(e,t){const n=E(e),r=await Gs(n.localStore,t.query,!0),s=t.view.ko(r);return n.isPrimaryClient&&Uo(n,t.targetId,s.Co),s}async function Qo(e){const t=E(e);return Qs(t.localStore).then((e=>$o(t,e)))}async function Wo(e,t,n,r){const s=E(e),i=await function(e,t){const n=E(e),r=E(n.An);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.Zt(e,t).next((t=>t?n.Wn.vn(e,t):vr.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await Gi(s.remoteStore):"acknowledged"===n||"rejected"===n?(Po(s,t,r||null),Oo(s,t),function(e,t){E(E(e).An).ee(t)}(s.localStore,t)):v(),await $o(s,i)):g("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Ho(e,t,n){const r=E(e),s=[],i=[];for(const o of t){let e;const t=r.Fo.get(o);if(t&&0!==t.length){e=await $s(r.localStore,tt(t[0]));for(const e of t){const t=r.Mo.get(e),n=await zo(r,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await zs(r.localStore,o);e=await $s(r.localStore,t),await Do(r,Yo(t),o,!1)}s.push(e)}return r.Oo.br(i),s}function Yo(e){return Qe(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Jo(e){const t=E(e);return E(E(t.localStore).persistence).Tn()}async function Xo(e,t,n,r){const s=E(e);if(s.Wo)g("SyncEngine","Ignoring unexpected query state notification.");else if(s.Fo.has(t))switch(n){case"current":case"not-current":{const e=await Qs(s.localStore),r=cn.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await $o(s,e,r);break}case"rejected":await js(s.localStore,t,!0),Vo(s,t,r);break;default:v()}}async function Zo(e,t,n){const r=ea(e);if(r.Wo){for(const e of t){if(r.Fo.has(e)){g("SyncEngine","Adding an already active target "+e);continue}const t=await zs(r.localStore,e),n=await $s(r.localStore,t);await Do(r,Yo(t),n.targetId,!1),Ri(r.remoteStore,n)}for(const e of n)r.Fo.has(e)&&await js(r.localStore,e,!1).then((()=>{Li(r.remoteStore,e),Vo(r,e)})).catch(ds)}}function ea(e){const t=E(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=xo.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Go.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Lo.bind(null,t),t.Oo.br=mo.bind(null,t.eventManager),t.Oo.zo=go.bind(null,t.eventManager),t}function ta(e){const t=E(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Mo.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Fo.bind(null,t),t}class na{constructor(){this.synchronizeTabs=!1}async initialize(e){this.k=Ei(e.databaseInfo.databaseId),this.sharedClientState=this.Jo(e),this.persistence=this.Yo(e),await this.persistence.start(),this.gcScheduler=this.Xo(e),this.localStore=this.Zo(e)}Xo(e){return null}Zo(e){return Vs(this.persistence,new Os,e.initialUser,this.k)}Yo(e){return new ni(si.ks,this.k)}Jo(e){return new mi}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ra extends na{constructor(e,t,n){super(),this.tc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await async function(e){const t=E(e);return t.persistence.runTransaction("Synchronize last document change read time","readonly",(e=>function(e){const t=Ss(e);let n=B.min();return t.jt({index:ar.readTimeIndex,reverse:!0},((e,t,r)=>{t.readTime&&(n=Vr(t.readTime)),r.done()})).next((()=>n))}(e))).then((e=>{t.jn=e}))}(this.localStore),await this.tc.initialize(this,e),await ta(this.tc.syncEngine),await Gi(this.tc.remoteStore),await this.persistence.sn((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}Zo(e){return Vs(this.persistence,new Os,e.initialUser,this.k)}Xo(e){const t=this.persistence.referenceDelegate.garbageCollector;return new gs(t,e.asyncQueue)}Yo(e){const t=Rs(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Zr.withCacheSize(this.cacheSizeBytes):Zr.DEFAULT;return new Ds(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Ii(),Ti(),this.k,this.sharedClientState,!!this.forceOwnership)}Jo(e){return new mi}}class sa extends ra{constructor(e,t){super(e,t,!1),this.tc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.tc.syncEngine;this.sharedClientState instanceof fi&&(this.sharedClientState.syncEngine={mi:Wo.bind(null,t),gi:Xo.bind(null,t),yi:Zo.bind(null,t),Tn:Jo.bind(null,t),_i:Qo.bind(null,t)},await this.sharedClientState.start()),await this.persistence.sn((async e=>{await async function(e,t){const n=E(e);if(ea(n),ta(n),!0===t&&!0!==n.Wo){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Ho(n,e.toArray());n.Wo=!0,await to(n.remoteStore,!0);for(const r of t)Ri(n.remoteStore,r)}else if(!1===t&&!1!==n.Wo){const e=[];let t=Promise.resolve();n.Fo.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(Vo(n,s),js(n.localStore,s,!0)))),Li(n.remoteStore,s)})),await t,await Ho(n,e),function(e){const t=E(e);t.Uo.forEach(((e,n)=>{Li(t.remoteStore,n)})),t.qo.hs(),t.Uo=new Map,t.Bo=new zt(ce.comparator)}(n),n.Wo=!1,await to(n.remoteStore,!1)}}(this.tc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):e||this.gcScheduler.stop())}))}Jo(e){const t=Ii();if(!fi.Pt(t))throw new S(b.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Rs(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new fi(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class ia{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Ro(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=jo.bind(null,this.syncEngine),await to(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new ho}createDatastore(e){const t=Ei(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new vi(r));var r;return function(e,t,n,r){return new Ai(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Ro(this.syncEngine,e,0),i=pi.Pt()?new pi:new gi,new Di(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new Ao(e,t,n,r,s,i);return o&&(a.Wo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=E(e);g("RemoteStore","RemoteStore shutting down."),t.Gr.add(5),await xi(t),t.Hr.shutdown(),t.Jr.set("Unknown")}(this.remoteStore)}}function oa(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class aa{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.ec(this.observer.next,e)}error(e){this.observer.error?this.ec(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)}nc(){this.muted=!0}ec(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class ca{constructor(e,t){this.sc=e,this.k=t,this.metadata=new k,this.buffer=new Uint8Array,this.ic=new TextDecoder("utf-8"),this.rc().then((e=>{e&&e._o()?this.metadata.resolve(e.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.payload)}`))}),(e=>this.metadata.reject(e)))}close(){return this.sc.cancel()}async getMetadata(){return this.metadata.promise}async Ho(){return await this.getMetadata(),this.rc()}async rc(){const e=await this.oc();if(null===e)return null;const t=this.ic.decode(e),n=Number(t);isNaN(n)&&this.cc(`length string (${t}) is not valid number`);const r=await this.ac(n);return new wo(JSON.parse(r),e.length+n)}uc(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async oc(){for(;this.uc()<0&&!(await this.hc()););if(0===this.buffer.length)return null;const e=this.uc();e<0&&this.cc("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async ac(e){for(;this.buffer.length<e;)await this.hc()&&this.cc("Reached the end of bundle when more is expected.");const t=this.ic.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}cc(e){throw this.sc.cancel(),new Error(`Invalid bundle format: ${e}`)}async hc(){const e=await this.sc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class ua{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new S(b.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=E(e),r=Cn(n.k)+"/documents",s={documents:t.map((e=>_n(n.k,e)))},i=await n.ji("BatchGetDocuments",r,s),o=new Map;i.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){I(!!t.found),t.found.name,t.found.updateTime;const n=An(e,t.found.name),r=bn(t.found.updateTime),s=new be({mapValue:{fields:t.found.fields}});return ke.newFoundDocument(n,r,s)}(e,t):"missing"in t?function(e,t){I(!!t.missing),I(!!t.readTime);const n=An(e,t.missing),r=bn(t.readTime);return ke.newNoDocument(n,r)}(e,t):v()}(n.k,e);o.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{const t=o.get(e.toString());I(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new qt(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=ce.fromPath(t);this.mutations.push(new Ut(n,this.precondition(n)))})),await async function(e,t){const n=E(e),r=Cn(n.k)+"/documents",s={writes:t.map((e=>Mn(n.k,e)))};await n.Bi("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw v();t=B.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new S(b.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?_t.updateTime(t):_t.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(B.min()))throw new S(b.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return _t.updateTime(t)}return _t.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class ha{constructor(e,t,n,r){this.asyncQueue=e,this.datastore=t,this.updateFunction=n,this.deferred=r,this.lc=5,this.ur=new bi(this.asyncQueue,"transaction_retry")}run(){this.lc-=1,this.fc()}fc(){this.ur.Zi((async()=>{const e=new ua(this.datastore),t=this.dc(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.wc(e)}))))})).catch((e=>{this.wc(e)}))}))}dc(e){try{const t=this.updateFunction(e);return!ie(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}wc(e){this.lc>0&&this._c(e)?(this.lc-=1,this.asyncQueue.enqueueAndForget((()=>(this.fc(),Promise.resolve())))):this.deferred.reject(e)}_c(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||!jt(t)}return!1}}class la{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=h.UNAUTHENTICATED,this.clientId=O.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{g("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(g("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new S(b.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new k;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=io(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function da(e,t){e.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await qs(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}async function fa(e,t){e.asyncQueue.verifyOperationInProgress();const n=await ma(e);g("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>eo(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>eo(t.remoteStore,n))),e.onlineComponents=t}async function ma(e){return e.offlineComponents||(g("FirestoreClient","Using default OfflineComponentProvider"),await da(e,new na)),e.offlineComponents}async function ga(e){return e.onlineComponents||(g("FirestoreClient","Using default OnlineComponentProvider"),await fa(e,new ia)),e.onlineComponents}function pa(e){return ma(e).then((e=>e.persistence))}function ya(e){return ma(e).then((e=>e.localStore))}function wa(e){return ga(e).then((e=>e.remoteStore))}function va(e){return ga(e).then((e=>e.syncEngine))}async function Ia(e){const t=await ga(e),n=t.eventManager;return n.onListen=No.bind(null,t.syncEngine),n.onUnlisten=Co.bind(null,t.syncEngine),n}function Ta(e,t,n={}){const r=new k;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new aa({next:i=>{t.enqueueAndForget((()=>fo(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new S(b.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new S(b.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new yo(We(n.path),i,{includeMetadataChanges:!0,wo:!0});return lo(e,o)}(await Ia(e),e.asyncQueue,t,n,r))),r.promise}function Ea(e,t,n={}){const r=new k;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new aa({next:n=>{t.enqueueAndForget((()=>fo(e,o))),n.fromCache&&"server"===r.source?s.reject(new S(b.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new yo(n,i,{includeMetadataChanges:!0,wo:!0});return lo(e,o)}(await Ia(e),e.asyncQueue,t,n,r))),r.promise}function ba(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?(new TextEncoder).encode(e):e,function(e,t){return new ca(e,t)}(function(e,t){if(e instanceof Uint8Array)return oa(e,t);if(e instanceof ArrayBuffer)return oa(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,Ei(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=E(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=E(e),r=bn(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.Ye.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),void n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r));n._updateProgress(To(r));const s=new Io(r,e.localStore,t.k);let i=await t.Ho();for(;i;){const e=await s.yo(i);e&&n._updateProgress(e),i=await t.Ho()}const o=await s.complete();await $o(e,o.In,void 0),await function(e,t){const n=E(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.Ye.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress)}catch(e){y("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e)}})(r,t,n).then((()=>{r.sharedClientState.notifyBundleLoaded()}))}(await va(e),s,r)}))}class Sa{constructor(e,t,n,r,s,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class ka{constructor(e,t){this.projectId=e,this.database=t||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof ka&&e.projectId===this.projectId&&e.database===this.database}}const _a=new Map;function Aa(e,t,n){if(!n)throw new S(b.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Na(e,t,n,r){if(!0===t&&!0===r)throw new S(b.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Da(e){if(!ce.isDocumentKey(e))throw new S(b.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Ca(e){if(ce.isDocumentKey(e))throw new S(b.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function xa(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":v()}function Ra(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new S(b.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=xa(e);throw new S(b.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function La(e,t){if(t<=0)throw new S(b.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Ma{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new S(b.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new S(b.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Na("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Fa{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Ma({}),this._settingsFrozen=!1,e instanceof ka?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new S(b.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ka(e.options.projectId)}(e))}get app(){if(!this._app)throw new S(b.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new S(b.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Ma(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new A;switch(e.type){case"gapi":const t=e.client;return I(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new x(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new S(b.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=_a.get(e);t&&(g("ComponentProvider","Removing Datastore"),_a.delete(e),t.terminate())}(this),Promise.resolve()}}function Oa(e,t,n,r={}){var s;const i=(e=Ra(e,Fa))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&y("Host has been set in both settings() and useEmulator(), emulator host will be used"),e._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${n}`,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=h.MOCK_USER;else{t=(0,o.Sg)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new S(b.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new h(i)}e._authCredentials=new N(new _(t,n))}}class Pa{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new qa(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Pa(this.firestore,e,this._key)}}class Va{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Va(this.firestore,e,this._query)}}class qa extends Va{constructor(e,t,n){super(e,t,We(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Pa(this.firestore,null,new ce(e))}withConverter(e){return new qa(this.firestore,e,this._path)}}function Ua(e,t,...n){if(e=(0,o.m9)(e),Aa("collection","path",t),e instanceof Fa){const r=z.fromString(t,...n);return Ca(r),new qa(e,null,r)}{if(!(e instanceof Pa||e instanceof qa))throw new S(b.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(z.fromString(t,...n));return Ca(r),new qa(e.firestore,null,r)}}function Ba(e,t){if(e=Ra(e,Fa),Aa("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new S(b.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Va(e,null,function(e){return new ze(z.emptyPath(),e)}(t))}function Ka(e,t,...n){if(e=(0,o.m9)(e),1===arguments.length&&(t=O.A()),Aa("doc","path",t),e instanceof Fa){const r=z.fromString(t,...n);return Da(r),new Pa(e,null,new ce(r))}{if(!(e instanceof Pa||e instanceof qa))throw new S(b.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(z.fromString(t,...n));return Da(r),new Pa(e.firestore,e instanceof qa?e.converter:null,new ce(r))}}function $a(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),(e instanceof Pa||e instanceof qa)&&(t instanceof Pa||t instanceof qa)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function ja(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),e instanceof Va&&t instanceof Va&&e.firestore===t.firestore&&rt(e._query,t._query)&&e.converter===t.converter}class Ga{constructor(){this.mc=Promise.resolve(),this.gc=[],this.yc=!1,this.Tc=[],this.Ec=null,this.Ic=!1,this.Ac=!1,this.Rc=[],this.ur=new bi(this,"async_queue_retry"),this.bc=()=>{const e=Ti();e&&g("AsyncQueue","Visibility state changed to "+e.visibilityState),this.ur.er()};const e=Ti();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.bc)}get isShuttingDown(){return this.yc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pc(),this.vc(e)}enterRestrictedMode(e){if(!this.yc){this.yc=!0,this.Ac=e||!1;const t=Ti();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.bc)}}enqueue(e){if(this.Pc(),this.yc)return new Promise((()=>{}));const t=new k;return this.vc((()=>this.yc&&this.Ac?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.gc.push(e),this.Vc())))}async Vc(){if(0!==this.gc.length){try{await this.gc[0](),this.gc.shift(),this.ur.reset()}catch(e){if(!Sr(e))throw e;g("AsyncQueue","Operation failed with retryable error: "+e)}this.gc.length>0&&this.ur.Zi((()=>this.Vc()))}}vc(e){const t=this.mc.then((()=>(this.Ic=!0,e().catch((e=>{this.Ec=e,this.Ic=!1;throw p("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e})).then((e=>(this.Ic=!1,e))))));return this.mc=t,t}enqueueAfterDelay(e,t,n){this.Pc(),this.Rc.indexOf(e)>-1&&(t=0);const r=so.createAndSchedule(this,e,t,n,(e=>this.Sc(e)));return this.Tc.push(r),r}Pc(){this.Ec&&v()}verifyOperationInProgress(){}async Dc(){let e;do{e=this.mc,await e}while(e!==this.mc)}Cc(e){for(const t of this.Tc)if(t.timerId===e)return!0;return!1}Nc(e){return this.Dc().then((()=>{this.Tc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.Tc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Dc()}))}kc(e){this.Rc.push(e)}Sc(e){const t=this.Tc.indexOf(e);this.Tc.splice(t,1)}}function za(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(e)}class Qa{constructor(){this._progressObserver={},this._taskCompletionResolver=new k,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const Wa=-1;class Ha extends Fa{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new Ga,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Ja(this),this._firestoreClient.terminate()}}function Ya(e){return e._firestoreClient||Ja(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Ja(e){var t;const n=e._freezeSettings(),r=function(e,t,n,r){return new Sa(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new la(e._authCredentials,e._appCheckCredentials,e._queue,r)}function Xa(e,t){ac(e=Ra(e,Ha));const n=Ya(e),r=e._freezeSettings(),s=new ia;return ec(n,s,new ra(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function Za(e){ac(e=Ra(e,Ha));const t=Ya(e),n=e._freezeSettings(),r=new ia;return ec(t,r,new sa(r,n.cacheSizeBytes))}function ec(e,t,n){const r=new k;return e.asyncQueue.enqueue((async()=>{try{await da(e,n),await fa(e,t),r.resolve()}catch(e){if(!function(e){return"FirebaseError"===e.name?e.code===b.FAILED_PRECONDITION||e.code===b.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)}(e))throw e;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e),r.reject(e)}})).then((()=>r.promise))}function tc(e){if(e._initialized&&!e._terminated)throw new S(b.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new k;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!Tr.Pt())return Promise.resolve();const t=e+"main";await Tr.delete(t)}(Rs(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function nc(e){return function(e){const t=new k;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=E(e);Vi(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=E(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.An.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.jo.get(e)||[];r.push(t),n.jo.set(e,r)}catch(e){const n=io(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await va(e),t))),t.promise}(Ya(e=Ra(e,Ha)))}function rc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await pa(e),n=await wa(e);return t.setNetworkEnabled(!0),function(e){const t=E(e);return t.Gr.delete(0),Ci(t)}(n)}))}(Ya(e=Ra(e,Ha)))}function sc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await pa(e),n=await wa(e);return t.setNetworkEnabled(!1),async function(e){const t=E(e);t.Gr.add(0),await xi(t),t.Jr.set("Offline")}(n)}))}(Ya(e=Ra(e,Ha)))}function ic(e,t){const n=Ya(e=Ra(e,Ha)),r=new Qa;return ba(n,e._databaseId,t,r),r}function oc(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=E(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.Ye.getNamedQuery(e,t)))}(await ya(e),t)))}(Ya(e=Ra(e,Ha)),t).then((t=>t?new Va(e,null,t.query):null))}function ac(e){if(e._initialized||e._terminated)throw new S(b.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class cc{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new S(b.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class uc{constructor(e){this._byteString=e}static fromBase64String(e){try{return new uc(J.fromBase64String(e))}catch(e){throw new S(b.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new uc(J.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class hc{constructor(e){this._methodName=e}}class lc{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new S(b.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new S(b.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return P(this._lat,e._lat)||P(this._long,e._long)}}const dc=/^__.*__$/;class fc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Ft(e,this.data,this.fieldMask,t,this.fieldTransforms):new Mt(e,this.data,t,this.fieldTransforms)}}class mc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Ft(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function gc(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class pc{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.k=n,this.ignoreUndefinedProperties=r,void 0===s&&this.xc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get $c(){return this.settings.$c}Oc(e){return new pc(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.k,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mc(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Oc({path:n,Fc:!1});return r.Lc(e),r}Bc(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Oc({path:n,Fc:!1});return r.xc(),r}Uc(e){return this.Oc({path:void 0,Fc:!0})}qc(e){return Oc(e,this.settings.methodName,this.settings.Kc||!1,this.path,this.settings.jc)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}xc(){if(this.path)for(let e=0;e<this.path.length;e++)this.Lc(this.path.get(e))}Lc(e){if(0===e.length)throw this.qc("Document fields must not be empty");if(gc(this.$c)&&dc.test(e))throw this.qc('Document fields cannot begin and end with "__"')}}class yc{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.k=n||Ei(e)}Qc(e,t,n,r=!1){return new pc({$c:e,methodName:t,jc:n,path:W.emptyPath(),Fc:!1,Kc:r},this.databaseId,this.k,this.ignoreUndefinedProperties)}}function wc(e){const t=e._freezeSettings(),n=Ei(e._databaseId);return new yc(e._databaseId,!!t.ignoreUndefinedProperties,n)}function vc(e,t,n,r,s,i={}){const o=e.Qc(i.merge||i.mergeFields?2:0,t,n,s);Rc("Data must be an object, but it was:",o,r);const a=Cc(r,o);let c,u;if(i.merge)c=new H(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Lc(t,r,n);if(!o.contains(s))throw new S(b.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Pc(e,s)||e.push(s)}c=new H(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new fc(new be(a),c,u)}class Ic extends hc{_toFieldTransform(e){if(2!==e.$c)throw 1===e.$c?e.qc(`${this._methodName}() can only appear at the top level of your update data`):e.qc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Ic}}function Tc(e,t,n){return new pc({$c:3,jc:t.settings.jc,methodName:e._methodName,Fc:n},t.databaseId,t.k,t.ignoreUndefinedProperties)}class Ec extends hc{_toFieldTransform(e){return new St(e.path,new pt)}isEqual(e){return e instanceof Ec}}class bc extends hc{constructor(e,t){super(e),this.Wc=t}_toFieldTransform(e){const t=Tc(this,e,!0),n=this.Wc.map((e=>Dc(e,t))),r=new yt(n);return new St(e.path,r)}isEqual(e){return this===e}}class Sc extends hc{constructor(e,t){super(e),this.Wc=t}_toFieldTransform(e){const t=Tc(this,e,!0),n=this.Wc.map((e=>Dc(e,t))),r=new vt(n);return new St(e.path,r)}isEqual(e){return this===e}}class kc extends hc{constructor(e,t){super(e),this.Gc=t}_toFieldTransform(e){const t=new Tt(e.k,lt(e.k,this.Gc));return new St(e.path,t)}isEqual(e){return this===e}}function _c(e,t,n,r){const s=e.Qc(1,t,n);Rc("Data must be an object, but it was:",s,r);const i=[],a=be.empty();$(r,((e,r)=>{const c=Fc(t,e,n);r=(0,o.m9)(r);const u=s.Bc(c);if(r instanceof Ic)i.push(c);else{const e=Dc(r,u);null!=e&&(i.push(c),a.set(c,e))}}));const c=new H(i);return new mc(a,c,s.fieldTransforms)}function Ac(e,t,n,r,s,i){const a=e.Qc(1,t,n),c=[Lc(t,r,n)],u=[s];if(i.length%2!=0)throw new S(b.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)c.push(Lc(t,i[o])),u.push(i[o+1]);const h=[],l=be.empty();for(let f=c.length-1;f>=0;--f)if(!Pc(h,c[f])){const e=c[f];let t=u[f];t=(0,o.m9)(t);const n=a.Bc(e);if(t instanceof Ic)h.push(e);else{const r=Dc(t,n);null!=r&&(h.push(e),l.set(e,r))}}const d=new H(h);return new mc(l,d,a.fieldTransforms)}function Nc(e,t,n,r=!1){return Dc(n,e.Qc(r?4:3,t))}function Dc(e,t){if(xc(e=(0,o.m9)(e)))return Rc("Unsupported field value:",t,e),Cc(e,t);if(e instanceof hc)return function(e,t){if(!gc(t.$c))throw t.qc(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.qc(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Fc&&4!==t.$c)throw t.qc("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=Dc(s,t.Uc(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return lt(t.k,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=U.fromDate(e);return{timestampValue:In(t.k,n)}}if(e instanceof U){const n=new U(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:In(t.k,n)}}if(e instanceof lc)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof uc)return{bytesValue:Tn(t.k,e._byteString)};if(e instanceof Pa){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.qc(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Sn(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.qc(`Unsupported field value: ${xa(e)}`)}(e,t)}function Cc(e,t){const n={};return j(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):$(e,((e,r)=>{const s=Dc(r,t.Mc(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function xc(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof U||e instanceof lc||e instanceof uc||e instanceof Pa||e instanceof hc)}function Rc(e,t,n){if(!xc(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=xa(n);throw"an object"===r?t.qc(e+" a custom object"):t.qc(e+" "+r)}}function Lc(e,t,n){if((t=(0,o.m9)(t))instanceof cc)return t._internalPath;if("string"==typeof t)return Fc(e,t);throw Oc("Field path arguments must be of type string or ",e,!1,void 0,n)}const Mc=new RegExp("[~\\*/\\[\\]]");function Fc(e,t,n){if(t.search(Mc)>=0)throw Oc(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new cc(...t.split("."))._internalPath}catch(r){throw Oc(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Oc(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new S(b.INVALID_ARGUMENT,a+e+c)}function Pc(e,t){return e.some((e=>e.isEqual(t)))}class Vc{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Pa(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new qc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Uc("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class qc extends Vc{data(){return super.data()}}function Uc(e,t){return"string"==typeof t?Fc(e,t):t instanceof cc?t._internalPath:t._delegate._internalPath}class Bc{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Kc extends Vc{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new $c(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Uc("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class $c extends Kc{data(e={}){return super.data(e)}}class jc{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Bc(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new $c(this._firestore,this._userDataWriter,n.key,n,new Bc(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new S(b.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>({type:"added",doc:new $c(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Bc(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter),oldIndex:-1,newIndex:t++})))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new $c(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Bc(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:Gc(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Gc(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function zc(e,t){return e instanceof Kc&&t instanceof Kc?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof jc&&t instanceof jc&&e._firestore===t._firestore&&ja(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Qc(e){if(Ye(e)&&0===e.explicitOrderBy.length)throw new S(b.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Wc{}function Hc(e,...t){for(const n of t)e=n._apply(e);return e}class Yc extends Wc{constructor(e,t,n){super(),this.zc=e,this.Hc=t,this.Jc=n,this.type="where"}_apply(e){const t=wc(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(b.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){lu(o,i);const t=[];for(const n of o)t.push(hu(r,e,n));a={arrayValue:{values:t}}}else a=hu(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||lu(o,i),a=Nc(n,"where",o,"in"===i||"not-in"===i);const c=xe.create(s,i,a);return function(e,t){if(t.V()){const n=Xe(e);if(null!==n&&!n.isEqual(t.field))throw new S(b.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${t.field.toString()}'`);const r=Je(e);null!==r&&du(e,t.field,r)}const n=function(e,t){for(const n of e.filters)if(t.indexOf(n.op)>=0)return n.op;return null}(e,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new S(b.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new S(b.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}(e,c),c}(e._query,0,t,e.firestore._databaseId,this.zc,this.Hc,this.Jc);return new Va(e.firestore,e.converter,function(e,t){const n=e.filters.concat([t]);return new ze(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}(e._query,n))}}function Jc(e,t,n){const r=t,s=Uc("where",e);return new Yc(s,r,n)}class Xc extends Wc{constructor(e,t){super(),this.zc=e,this.Yc=t,this.type="orderBy"}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new S(b.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new S(b.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new Ke(t,n);return function(e,t){if(null===Je(e)){const n=Xe(e);null!==n&&du(e,n,t.field)}}(e,r),r}(e._query,this.zc,this.Yc);return new Va(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new ze(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function Zc(e,t="asc"){const n=t,r=Uc("orderBy",e);return new Xc(r,n)}class eu extends Wc{constructor(e,t,n){super(),this.type=e,this.Xc=t,this.Zc=n}_apply(e){return new Va(e.firestore,e.converter,nt(e._query,this.Xc,this.Zc))}}function tu(e){return La("limit",e),new eu("limit",e,"F")}function nu(e){return La("limitToLast",e),new eu("limitToLast",e,"L")}class ru extends Wc{constructor(e,t,n){super(),this.type=e,this.ta=t,this.ea=n}_apply(e){const t=uu(e,this.type,this.ta,this.ea);return new Va(e.firestore,e.converter,function(e,t){return new ze(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function su(...e){return new ru("startAt",e,!0)}function iu(...e){return new ru("startAfter",e,!1)}class ou extends Wc{constructor(e,t,n){super(),this.type=e,this.ta=t,this.ea=n}_apply(e){const t=uu(e,this.type,this.ta,this.ea);return new Va(e.firestore,e.converter,function(e,t){return new ze(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function au(...e){return new ou("endBefore",e,!0)}function cu(...e){return new ou("endAt",e,!1)}function uu(e,t,n,r){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof Vc)return function(e,t,n,r,s){if(!r)throw new S(b.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of et(e))if(o.field.isKeyField())i.push(pe(t,r.key));else{const e=r.data.field(o.field);if(ne(e))throw new S(b.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new S(b.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Ue(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=wc(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new S(b.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let c=0;c<s.length;c++){const i=s[c];if(o[c].field.isKeyField()){if("string"!=typeof i)throw new S(b.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!Ze(e)&&-1!==i.indexOf("/"))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(z.fromString(i));if(!ce.isDocumentKey(n))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new ce(n);a.push(pe(t,s))}else{const e=Nc(n,r,i);a.push(e)}}return new Ue(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function hu(e,t,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(b.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ze(t)&&-1!==n.indexOf("/"))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(z.fromString(n));if(!ce.isDocumentKey(r))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return pe(e,new ce(r))}if(n instanceof Pa)return pe(e,n._key);throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${xa(n)}.`)}function lu(e,t){if(!Array.isArray(e)||0===e.length)throw new S(b.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new S(b.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function du(e,t,n){if(!n.isEqual(t))throw new S(b.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class fu{convertValue(e,t="none"){switch(ue(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ee(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(te(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw v()}}convertObject(e,t){const n={};return $(e.fields,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new lc(ee(e.latitude),ee(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=re(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(se(e));default:return null}}convertTimestamp(e){const t=Z(e);return new U(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=z.fromString(e);I(Hn(n));const r=new ka(n.get(1),n.get(3)),s=new ce(n.popFirst(5));return r.isEqual(t)||p(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function mu(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class gu extends fu{constructor(e){super(),this.firestore=e}convertBytes(e){return new uc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Pa(this.firestore,null,t)}}class pu{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=wc(e)}set(e,t,n){this._verifyNotCommitted();const r=yu(e,this._firestore),s=mu(r.converter,t,n),i=vc(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,_t.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=yu(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof cc?Ac(this._dataReader,"WriteBatch.update",s._key,t,n,r):_c(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,_t.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=yu(e,this._firestore);return this._mutations=this._mutations.concat(new qt(t._key,_t.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(b.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function yu(e,t){if((e=(0,o.m9)(e)).firestore!==t)throw new S(b.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}function wu(e){e=Ra(e,Pa);const t=Ra(e.firestore,Ha);return Ta(Ya(t),e._key).then((n=>Ru(t,e,n)))}class vu extends fu{constructor(e){super(),this.firestore=e}convertBytes(e){return new uc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Pa(this.firestore,null,t)}}function Iu(e){e=Ra(e,Pa);const t=Ra(e.firestore,Ha),n=Ya(t),r=new vu(t);return function(e,t){const n=new k;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=E(e);return n.persistence.runTransaction("read document","readonly",(e=>n.Wn.Rn(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new S(b.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=io(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await ya(e),t,n))),n.promise}(n,e._key).then((n=>new Kc(t,r,e._key,n,new Bc(null!==n&&n.hasLocalMutations,!0),e.converter)))}function Tu(e){e=Ra(e,Pa);const t=Ra(e.firestore,Ha);return Ta(Ya(t),e._key,{source:"server"}).then((n=>Ru(t,e,n)))}function Eu(e){e=Ra(e,Va);const t=Ra(e.firestore,Ha),n=Ya(t),r=new vu(t);return Qc(e._query),Ea(n,e._query).then((n=>new jc(t,r,e,n)))}function bu(e){e=Ra(e,Va);const t=Ra(e.firestore,Ha),n=Ya(t),r=new vu(t);return function(e,t){const n=new k;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Gs(e,t,!0),s=new So(t,r.zn),i=s.Po(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=io(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await ya(e),t,n))),n.promise}(n,e._query).then((n=>new jc(t,r,e,n)))}function Su(e){e=Ra(e,Va);const t=Ra(e.firestore,Ha),n=Ya(t),r=new vu(t);return Ea(n,e._query,{source:"server"}).then((n=>new jc(t,r,e,n)))}function ku(e,t,n){e=Ra(e,Pa);const r=Ra(e.firestore,Ha),s=mu(e.converter,t,n);return xu(r,[vc(wc(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,_t.none())])}function _u(e,t,n,...r){e=Ra(e,Pa);const s=Ra(e.firestore,Ha),i=wc(s);let a;return a="string"==typeof(t=(0,o.m9)(t))||t instanceof cc?Ac(i,"updateDoc",e._key,t,n,r):_c(i,"updateDoc",e._key,t),xu(s,[a.toMutation(e._key,_t.exists(!0))])}function Au(e){return xu(Ra(e.firestore,Ha),[new qt(e._key,_t.none())])}function Nu(e,t){const n=Ra(e.firestore,Ha),r=Ka(e),s=mu(e.converter,t);return xu(n,[vc(wc(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,_t.exists(!1))]).then((()=>r))}function Du(e,...t){var n,r,s;e=(0,o.m9)(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||za(t[a])||(i=t[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges};if(za(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let u,h,l;if(e instanceof Pa)h=Ra(e.firestore,Ha),l=We(e._key.path),u={next:n=>{t[a]&&t[a](Ru(h,e,n))},error:t[a+1],complete:t[a+2]};else{const n=Ra(e,Va);h=Ra(n.firestore,Ha),l=n._query;const r=new vu(h);u={next:e=>{t[a]&&t[a](new jc(h,r,n,e))},error:t[a+1],complete:t[a+2]},Qc(e._query)}return function(e,t,n,r){const s=new aa(r),i=new yo(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>lo(await Ia(e),i))),()=>{s.nc(),e.asyncQueue.enqueueAndForget((async()=>fo(await Ia(e),i)))}}(Ya(h),l,c,u)}function Cu(e,t){return function(e,t){const n=new aa(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).io.add(t),t.next()}(await Ia(e),n))),()=>{n.nc(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).io.delete(t)}(await Ia(e),n)))}}(Ya(e=Ra(e,Ha)),za(t)?t:{next:t})}function xu(e,t){return function(e,t){const n=new k;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=ta(e);try{const e=await function(e,t){const n=E(e),r=U.now(),s=t.reduce(((e,t)=>e.add(t.key)),sn());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>n.Wn.vn(e,s).next((s=>{i=s;const o=[];for(const e of t){const t=xt(e,i.get(e.key));null!=t&&o.push(new Ft(e.key,t,Se(t.value.mapValue),_t.exists(!0)))}return n.An.addMutationBatch(e,r,o,t)})))).then((e=>(e.applyToLocalDocumentSet(i),{batchId:e.batchId,changes:i})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Ko[e.currentUser.toKey()];r||(r=new zt(P)),r=r.insert(t,n),e.Ko[e.currentUser.toKey()]=r}(r,e.batchId,n),await $o(r,e.changes),await Gi(r.remoteStore)}catch(e){const t=io(e,"Failed to persist write");n.reject(t)}}(await va(e),t,n))),n.promise}(Ya(e),t)}function Ru(e,t,n){const r=n.docs.get(t._key),s=new vu(e);return new Kc(e,s,t._key,r,new Bc(n.hasPendingWrites,n.fromCache),t.converter)}class Lu extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=wc(e)}get(e){const t=yu(e,this._firestore),n=new gu(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return v();const r=e[0];if(r.isFoundDocument())return new Vc(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new Vc(this._firestore,n,t._key,null,t.converter);throw v()}))}set(e,t,n){const r=yu(e,this._firestore),s=mu(r.converter,t,n),i=vc(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=yu(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof cc?Ac(this._dataReader,"Transaction.update",s._key,t,n,r):_c(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=yu(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=yu(e,this._firestore),n=new vu(this._firestore);return super.get(e).then((e=>new Kc(this._firestore,n,t._key,e._document,new Bc(!1,!1),t.converter)))}}function Mu(e,t){return function(e,t){const n=new k;return e.asyncQueue.enqueueAndForget((async()=>{const r=await function(e){return ga(e).then((e=>e.datastore))}(e);new ha(e.asyncQueue,r,t,n).run()})),n.promise}(Ya(e=Ra(e,Ha)),(n=>t(new Lu(e,n))))}function Fu(){return new Ic("deleteField")}function Ou(){return new Ec("serverTimestamp")}function Pu(...e){return new bc("arrayUnion",e)}function Vu(...e){return new Sc("arrayRemove",e)}function qu(e){return new kc("increment",e)}!function(e,t=!0){!function(e){l=e}(r.SDK_VERSION),(0,r._registerComponent)(new s.wA("firestore",((e,{options:n})=>{const r=e.getProvider("app").getImmediate(),s=new Ha(r,new D(e.getProvider("auth-internal")),new L(e.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:t},n),s._setSettings(n),s}),"PUBLIC")),(0,r.registerVersion)(u,"3.4.4",e),(0,r.registerVersion)(u,"3.4.4","esm2017")}()}}]);